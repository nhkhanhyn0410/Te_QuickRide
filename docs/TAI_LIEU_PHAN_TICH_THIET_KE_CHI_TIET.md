# T√ÄI LI·ªÜU PH√ÇN T√çCH V√Ä THI·∫æT K·∫æ H·ªÜ TH·ªêNG
## ·ª®NG D·ª§NG WEB ƒê·∫∂T V√â XE KH√ÅCH TR·ª∞C TUY·∫æN

---

## M·ª§C L·ª§C
1. [Kh·∫£o s√°t Nghi·ªáp v·ª•] (ƒê√£ t·ªìn t·∫°i trong t√†i li·ªáu kh√¥ng ch·ªânh s·ª≠a)
2. [M√¥ t·∫£ B√†i to√°n](ƒê√£ t·ªìn t·∫°i trong t√†i li·ªáu kh√¥ng ch·ªânh s·ª≠a)
3. [X√°c ƒë·ªãnh Y√™u c·∫ßu](ƒê√£ t·ªìn t·∫°i trong t√†i li·ªáu kh√¥ng ch·ªânh s·ª≠a)
4. [X√°c ƒë·ªãnh T√°c nh√¢n v√† Use Case](Bao g·ªìm c·∫£ s∆° ƒë·ªì ƒê√£ t·ªìn t·∫°i trong t√†i li·ªáu kh√¥ng ch·ªânh s·ª≠a)
5. [ƒê·∫∑c T·∫£ Chi Ti·∫øt 28 Use Cases](#1-ƒë·∫∑c-t·∫£-chi-ti·∫øt-28-use-cases)
6. [X√°c ƒê·ªãnh L·ªõp v√† Quan H·ªá](#2-x√°c-ƒë·ªãnh-l·ªõp-v√†-quan-h·ªá)
7. [S∆° ƒê·ªì Lu·ªìng Ho·∫°t ƒê·ªông](#3-s∆°-ƒë·ªì-lu·ªìng-ho·∫°t-ƒë·ªông)
8. [Thi·∫øt K·∫ø Ki·∫øn Tr√∫c H·ªá Th·ªëng](#4-thi·∫øt-k·∫ø-ki·∫øn-tr√∫c-h·ªá-th·ªëng)

---

## 1. ƒê·∫∂C T·∫¢ CHI TI·∫æT 28 USE CASES

### 1.1 Nh√≥m Use Cases cho Customer

### ƒê√£ xong

## 2. X√ÅC ƒê·ªäNH L·ªöP V√Ä QUAN H·ªÜ

> **L∆∞u √Ω:** Ph·∫ßn n√†y ƒë∆∞·ª£c ƒë·ªìng b·ªô 100% v·ªõi MongoDB models hi·ªán c√≥ trong folder `backend/src/models/`

### 2.1 Danh S√°ch C√°c MongoDB Models (ƒê√£ Implement)

#### **2.1.1 Nh√≥m L·ªõp Ng∆∞·ªùi D√πng (User Domain)**

**1. User Model** ‚úÖ _ƒê√£ implement: `backend/src/models/User.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK - auto generated by MongoDB)
  - email: String (required, unique, lowercase)
  - phone: String (required, unique)
  - password: String (required, minlength: 8, hashed with bcrypt, select: false)
  - fullName: String (required)
  - dateOfBirth: Date (optional)
  - gender: Enum ('male', 'female', 'other')
  - avatar: String (URL)
  - role: Enum ('customer', 'admin') - default: 'customer'

  - **OAuth:**
    - googleId: String
    - facebookId: String

  - **Verification:**
    - isEmailVerified: Boolean (default: false)
    - isPhoneVerified: Boolean (default: false)
    - emailVerificationToken: String
    - phoneVerificationOTP: String
    - otpExpires: Date

  - **Security:**
    - passwordResetToken: String
    - passwordResetExpires: Date
    - lastLogin: Date

  - **Preferences:**
    - savedPassengers: Array of embedded documents
      - fullName: String
      - phone: String
      - idCard: String

  - **Loyalty:**
    - loyaltyTier: Enum ('bronze', 'silver', 'gold', 'platinum') - default: 'bronze'
    - totalPoints: Number (default: 0)

  - **Status:**
    - isActive: Boolean (default: true)
    - isBlocked: Boolean (default: false)

  - createdAt: DateTime (auto - timestamps)
  - updatedAt: DateTime (auto - timestamps)

- **Indexes:**
  - email: 1
  - phone: 1
  - googleId: 1
  - facebookId: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Pre-save hook: Hash password v·ªõi bcrypt (salt rounds: 12)
  - comparePassword(candidatePassword): Promise<Boolean>
  - toJSON(): Object (·∫©n c√°c field nh·∫°y c·∫£m)

- **Ghi ch√∫:**
  - Trong thi·∫øt k·∫ø ban ƒë·∫ßu c√≥ t√°ch Customer v√† Guest, nh∆∞ng trong code hi·ªán t·∫°i User model x·ª≠ l√Ω c·∫£ hai roles th√¥ng qua field `role` v√† logic x√°c th·ª±c

**2. BusOperator Model** ‚úÖ _ƒê√£ implement: `backend/src/models/BusOperator.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - companyName: String (required, unique)
  - email: String (required, unique, lowercase)
  - phone: String (required)
  - password: String (required, minlength: 8, hashed, select: false)

  - **Business Info:**
    - businessLicense: String (required)
    - taxCode: String (required)
    - logo: String (URL)
    - description: String
    - website: String

  - **Address (embedded object):**
    - street: String
    - ward: String
    - district: String
    - city: String
    - country: String (default: 'Vietnam')

  - **Bank Info (embedded object):**
    - bankName: String
    - accountNumber: String
    - accountHolder: String

  - **Approval:**
    - verificationStatus: Enum ('pending', 'approved', 'rejected') - default: 'pending'
    - verifiedAt: Date
    - verifiedBy: ObjectId (ref: 'User')
    - rejectionReason: String

  - **Rating:**
    - averageRating: Number (default: 0, min: 0, max: 5)
    - totalReviews: Number (default: 0)

  - **Statistics:**
    - totalTrips: Number (default: 0)
    - totalRevenue: Number (default: 0)

  - **Commission:**
    - commissionRate: Number (default: 5, min: 0, max: 100) // Percentage

  - **Status:**
    - isActive: Boolean (default: true)
    - isSuspended: Boolean (default: false)
    - suspensionReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - companyName: 1
  - email: 1
  - verificationStatus: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Pre-save hook: Hash password v·ªõi bcrypt (salt rounds: 12)
  - comparePassword(candidatePassword): Promise<Boolean>
  - toJSON(): Object (·∫©n password)

#### **2.1.2 Nh√≥m L·ªõp Tuy·∫øn ƒê∆∞·ªùng v√† L·ªãch Tr√¨nh (Route & Schedule Domain)**

**3. Route Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Route.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - routeName: String (required)
  - routeCode: String (required, unique, uppercase)

  - **Origin (embedded locationSchema):**
    - city: String (required)
    - province: String (required)
    - station: String
    - address: String
    - coordinates: { lat: Number, lng: Number }

  - **Destination (embedded locationSchema):**
    - city: String (required)
    - province: String (required)
    - station: String
    - address: String
    - coordinates: { lat: Number, lng: Number }

  - **Pickup & Dropoff Points (embedded pointSchema):**
    - pickupPoints: Array of { name: String, address: String, coordinates: {lat, lng} }
    - dropoffPoints: Array of { name: String, address: String, coordinates: {lat, lng} }

  - **Route Details:**
    - distance: Number (required, min: 0) // km
    - estimatedDuration: Number (required, min: 0) // minutes

  - **Status:**
    - isActive: Boolean (default: true)

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - routeCode: 1
  - operatorId: 1
  - 'origin.city': 1, 'destination.city': 1

- **Ghi ch√∫:**
  - Location v√† Point ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded schema, kh√¥ng ph·∫£i separate collection

**4. Bus Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Bus.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - busNumber: String (required, unique, uppercase) // License plate
  - busType: Enum ('limousine', 'sleeper', 'seater', 'double_decker') - required

  - **Seat Configuration (embedded seatLayout):**
    - seatLayout.floors: Number (required, min: 1, max: 2)
    - seatLayout.rows: Number (required)
    - seatLayout.columns: Number (required)
    - seatLayout.layout: Array of Array of String (required) // 2D array representing seat map

  - totalSeats: Number (required, min: 1)

  - **Amenities:**
    - amenities: Array of Enum ('wifi', 'ac', 'toilet', 'water', 'blanket', 'tv', 'usb_charger', 'reading_light')

  - **Images:**
    - images: Array of String (URLs)

  - **Status:**
    - isActive: Boolean (default: true)
    - maintenanceStatus: Enum ('good', 'maintenance', 'repair') - default: 'good'

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - operatorId: 1
  - busNumber: 1

- **Ghi ch√∫:**
  - SeatLayout ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded object, kh√¥ng ph·∫£i separate collection
  - Seat configuration ƒë∆∞·ª£c l∆∞u tr·ªØ d∆∞·ªõi d·∫°ng 2D array trong field layout

**5. Trip Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Trip.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - routeId: ObjectId (ref: 'Route', required)
  - busId: ObjectId (ref: 'Bus', required)
  - tripCode: String (required, unique, uppercase)

  - **Schedule:**
    - departureTime: Date (required)
    - arrivalTime: Date (required)

  - **Pricing:**
    - basePrice: Number (required, min: 0)

  - **Seat Availability:**
    - availableSeats: Number (required)
    - occupiedSeats: Array of String // Seat numbers
    - lockedSeats: Array of embedded objects
      - seatNumber: String
      - lockedUntil: Date
      - sessionId: String

  - **Staff Assignment:**
    - driver: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_
    - tripManager: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - **Status:**
    - status: Enum ('scheduled', 'boarding', 'in_progress', 'completed', 'cancelled') - default: 'scheduled'
    - cancellationReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - tripCode: 1
  - operatorId: 1, departureTime: 1
  - routeId: 1, departureTime: 1
  - departureTime: 1, status: 1

- **Ph∆∞∆°ng th·ª©c:**
  - isSeatAvailable(seatNumber): Boolean
  - lockSeats(seatNumbers, sessionId, durationMinutes = 15): Promise
  - releaseLocks(sessionId): Promise
  - occupySeats(seatNumbers): Promise

- **Ghi ch√∫:**
  - SeatLock ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded array, kh√¥ng ph·∫£i separate collection
  - Staff model ch∆∞a ƒë∆∞·ª£c t·∫°o, c·∫ßn implement tr∆∞·ªõc khi deploy production

#### **2.1.3 Nh√≥m L·ªõp ƒê·∫∑t V√© (Booking Domain)**

**6. Booking Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Booking.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - bookingCode: String (required, unique, uppercase) // Format: BKYYYYMMDD####
  - customerId: ObjectId (ref: 'User', required)
  - tripId: ObjectId (ref: 'Trip', required)
  - operatorId: ObjectId (ref: 'BusOperator', required)

  - **Seats (array of embedded objects):**
    - seats: Array of
      - seatNumber: String (required)
      - passenger: embedded object
        - fullName: String (required)
        - phone: String (required)
        - idCard: String

  - **Pickup & Dropoff (embedded objects):**
    - pickupPoint: { name: String, address: String, coordinates: {lat, lng} }
    - dropoffPoint: { name: String, address: String, coordinates: {lat, lng} }

  - **Pricing:**
    - subtotal: Number (required, min: 0)
    - discount: Number (default: 0, min: 0)
    - totalAmount: Number (required, min: 0)

  - **Voucher:**
    - voucherId: ObjectId (ref: 'Voucher') ‚ö†Ô∏è _Voucher model ch∆∞a t·∫°o_
    - voucherCode: String

  - **Contact:**
    - contactEmail: String (required)
    - contactPhone: String (required)
    - notes: String

  - **Status:**
    - status: Enum ('pending', 'confirmed', 'cancelled', 'completed') - default: 'pending'

  - **Cancellation:**
    - cancellationReason: String
    - cancelledAt: Date
    - refundAmount: Number (default: 0)
    - refundStatus: Enum ('pending', 'processed', 'failed')

  - **Check-in:**
    - checkedInSeats: Array of String
    - checkedInAt: Date
    - checkedInBy: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - bookingCode: 1
  - customerId: 1
  - tripId: 1
  - status: 1
  - createdAt: -1

- **Static Methods:**
  - generateBookingCode(): Promise<String> // Generates unique booking code

- **Ghi ch√∫:**
  - Passenger ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded object trong seats array, kh√¥ng ph·∫£i separate collection
  - Voucher model ch∆∞a ƒë∆∞·ª£c t·∫°o

**7. Ticket Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Ticket.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - ticketCode: String (required, unique, uppercase) // Format: TKYYYYMMDD####
  - bookingId: ObjectId (ref: 'Booking', required)
  - customerId: ObjectId (ref: 'User', required)
  - tripId: ObjectId (ref: 'Trip', required)

  - **Seat & Passenger Info (embedded):**
    - seatNumber: String (required)
    - passenger: embedded object
      - fullName: String (required)
      - phone: String (required)
      - idCard: String

  - **QR Code:**
    - qrCode: String (required) // Base64 image
    - qrData: String (required) // Encrypted data for verification

  - **Ticket PDF:**
    - ticketPDF: String // URL to PDF file

  - **Validation:**
    - isValid: Boolean (default: true)
    - isUsed: Boolean (default: false)
    - usedAt: Date
    - validatedBy: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - **Trip Details (denormalized for quick access):**
    - tripDetails: embedded object
      - routeName: String
      - origin: String
      - destination: String
      - departureTime: Date
      - busNumber: String
      - operatorName: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - ticketCode: 1
  - bookingId: 1
  - qrData: 1
  - customerId: 1

- **Static Methods:**
  - generateTicketCode(): Promise<String>

- **Ghi ch√∫:**
  - Trip details ƒë∆∞·ª£c denormalize ƒë·ªÉ tr√°nh join khi hi·ªÉn th·ªã v√©
  - QR code data ƒë∆∞·ª£c m√£ h√≥a ƒë·ªÉ b·∫£o m·∫≠t

#### **2.1.4 Nh√≥m L·ªõp Thanh To√°n (Payment Domain)**

**8. Payment Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Payment.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - transactionId: String (required, unique) // Format: TXN{timestamp}{random}
  - bookingId: ObjectId (ref: 'Booking', required)
  - customerId: ObjectId (ref: 'User', required)

  - **Amount:**
    - amount: Number (required, min: 0)
    - currency: String (default: 'VND')

  - **Payment Method:**
    - paymentMethod: Enum ('momo', 'vnpay', 'zalopay', 'shopeepay', 'atm', 'visa', 'mastercard', 'cod') - required

  - **Gateway Info:**
    - gatewayTransactionId: String
    - gatewayResponse: Mixed (object ch·ª©a response t·ª´ payment gateway)

  - **Status:**
    - status: Enum ('pending', 'success', 'failed', 'refunded') - default: 'pending'

  - **Refund:**
    - refundAmount: Number (default: 0)
    - refundedAt: Date
    - refundReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - transactionId: 1
  - bookingId: 1
  - customerId: 1
  - status: 1
  - createdAt: -1

- **Static Methods:**
  - generateTransactionId(): Promise<String>

### 2.2 Danh S√°ch C√°c Models C·∫ßn Implement (Ch∆∞a C√≥ Trong Code)

> **‚ö†Ô∏è L∆∞u √Ω:** C√°c models d∆∞·ªõi ƒë√¢y ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t trong thi·∫øt k·∫ø nh∆∞ng CH∆ØA ƒë∆∞·ª£c implement trong code. C·∫ßn t·∫°o tr∆∞·ªõc khi deploy production.

#### **Models C·∫ßn ∆Øu Ti√™n Cao (Critical)**

**9. Staff Model** üî¥ _Ch∆∞a implement - CRITICAL_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/Staff.js`
- **L√Ω do quan tr·ªçng:** Trip model ƒëang reference Staff model cho driver v√† tripManager
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - employeeCode: String (required, unique)
  - fullName: String (required)
  - phone: String (required)
  - email: String
  - role: Enum ('driver', 'tripManager') - required
  - status: Enum ('active', 'onLeave', 'resigned') - default: 'active'
  - password: String (hashed)
  - createdAt: DateTime
  - updatedAt: DateTime

**10. Voucher Model** üü° _Ch∆∞a implement - IMPORTANT_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/Voucher.js`
- **L√Ω do quan tr·ªçng:** Booking model ƒëang reference Voucher model
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - code: String (required, unique, uppercase)
  - discountType: Enum ('percentage', 'fixed') - required
  - discountValue: Number (required)
  - maxDiscount: Number (for percentage type)
  - minOrderValue: Number (default: 0)
  - validFrom: Date (required)
  - validTo: Date (required)
  - usageLimit: Number
  - usedCount: Number (default: 0)
  - operatorId: ObjectId (ref: 'BusOperator') // null = system voucher
  - isActive: Boolean (default: true)
  - createdAt: DateTime
  - updatedAt: DateTime

#### **Models C·∫ßn ∆Øu Ti√™n Trung B√¨nh (Nice to Have)**

**11. Review Model** üü¢ _Ch∆∞a implement - NICE TO HAVE_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/Review.js`
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - bookingId: ObjectId (ref: 'Booking', required)
  - customerId: ObjectId (ref: 'User', required)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - tripId: ObjectId (ref: 'Trip')
  - overallRating: Number (required, min: 1, max: 5)
  - busRating: Number (min: 1, max: 5)
  - driverRating: Number (min: 1, max: 5)
  - punctualityRating: Number (min: 1, max: 5)
  - serviceRating: Number (min: 1, max: 5)
  - comment: String
  - createdAt: DateTime
  - updatedAt: DateTime

**12. Notification Model** üü¢ _Ch∆∞a implement - NICE TO HAVE_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/Notification.js`
- **Ghi ch√∫:** Hi·ªán t·∫°i c√≥ `notificationService.js` nh∆∞ng kh√¥ng c√≥ model ƒë·ªÉ l∆∞u l·ªãch s·ª≠
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - userId: ObjectId (ref: 'User')
  - type: Enum ('email', 'sms', 'push')
  - title: String (required)
  - content: String (required)
  - status: Enum ('pending', 'sent', 'failed') - default: 'pending'
  - sentAt: Date
  - metadata: Mixed (object ch·ª©a th√¥ng tin b·ªï sung)
  - createdAt: DateTime

**13. Content Model** üü¢ _Ch∆∞a implement - NICE TO HAVE_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/Content.js`
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - type: Enum ('banner', 'blog', 'faq', 'policy')
  - title: String (required)
  - body: String (required)
  - imageUrl: String
  - isActive: Boolean (default: true)
  - order: Number (for sorting)
  - createdBy: ObjectId (ref: 'User')
  - createdAt: DateTime
  - updatedAt: DateTime

**14. SupportTicket Model** üü¢ _Ch∆∞a implement - NICE TO HAVE_
- **File ƒë·ªÅ xu·∫•t:** `backend/src/models/SupportTicket.js`
- **Thu·ªôc t√≠nh ƒë·ªÅ xu·∫•t:**
  - _id: ObjectId (PK)
  - userId: ObjectId (ref: 'User', required)
  - subject: String (required)
  - description: String (required)
  - category: Enum ('booking', 'payment', 'refund', 'technical', 'other')
  - priority: Enum ('low', 'medium', 'high', 'urgent') - default: 'medium'
  - status: Enum ('open', 'assigned', 'inProgress', 'resolved', 'closed') - default: 'open'
  - assignedTo: ObjectId (ref: 'User') // Admin user
  - messages: Array of embedded { sender: ObjectId, message: String, createdAt: Date }
  - createdAt: DateTime
  - updatedAt: DateTime
  - resolvedAt: Date

### 2.3 T√≥m T·∫Øt Tr·∫°ng Th√°i Implementation

| # | Model | Status | File Path | Priority |
|---|-------|--------|-----------|----------|
| 1 | User | ‚úÖ Implemented | `backend/src/models/User.js` | - |
| 2 | BusOperator | ‚úÖ Implemented | `backend/src/models/BusOperator.js` | - |
| 3 | Route | ‚úÖ Implemented | `backend/src/models/Route.js` | - |
| 4 | Bus | ‚úÖ Implemented | `backend/src/models/Bus.js` | - |
| 5 | Trip | ‚úÖ Implemented | `backend/src/models/Trip.js` | - |
| 6 | Booking | ‚úÖ Implemented | `backend/src/models/Booking.js` | - |
| 7 | Ticket | ‚úÖ Implemented | `backend/src/models/Ticket.js` | - |
| 8 | Payment | ‚úÖ Implemented | `backend/src/models/Payment.js` | - |
| 9 | **Staff** | üî¥ **Not Implemented** | `backend/src/models/Staff.js` | **CRITICAL** |
| 10 | **Voucher** | üü° **Not Implemented** | `backend/src/models/Voucher.js` | **IMPORTANT** |
| 11 | Review | üü¢ Not Implemented | `backend/src/models/Review.js` | Nice to Have |
| 12 | Notification | üü¢ Not Implemented | `backend/src/models/Notification.js` | Nice to Have |
| 13 | Content | üü¢ Not Implemented | `backend/src/models/Content.js` | Nice to Have |
| 14 | SupportTicket | üü¢ Not Implemented | `backend/src/models/SupportTicket.js` | Nice to Have |

---

### 2.4 Class Diagram (S∆° ƒê·ªì L·ªõp - MongoDB Models Implemented)

> **Ch√∫ th√≠ch:** S∆° ƒë·ªì n√†y ch·ªâ hi·ªÉn th·ªã c√°c models ƒê√É ƒê∆Ø·ª¢C IMPLEMENT trong code. Models m√†u xanh l√° l√† ƒë√£ c√≥, m√†u ƒë·ªè l√† ch∆∞a implement nh∆∞ng ƒë∆∞·ª£c reference.

```mermaid
classDiagram
    %% ========== IMPLEMENTED MODELS (Red) ==========

    %% User Model
    class User {
        <<MongoDB Model>>
        -ObjectId _id
        -String email*
        -String phone*
        -String password
        -String fullName*
        -Date dateOfBirth
        -Enum gender
        -String avatar
        -Enum role
        -String googleId
        -String facebookId
        -Boolean isEmailVerified
        -Boolean isPhoneVerified
        -Array savedPassengers
        -Enum loyaltyTier
        -Number totalPoints
        -Boolean isActive
        -Boolean isBlocked
        +comparePassword()
        +toJSON()
    }

    %% BusOperator Model
    class BusOperator {
        <<MongoDB Model>>
        -ObjectId _id
        -String companyName*
        -String email*
        -String phone*
        -String password
        -String businessLicense*
        -String taxCode*
        -String logo
        -Object address
        -Object bankAccount
        -Enum verificationStatus
        -Date verifiedAt
        -Number averageRating
        -Number totalReviews
        -Number totalTrips
        -Number totalRevenue
        -Number commissionRate
        -Boolean isActive
        -Boolean isSuspended
        +comparePassword()
        +toJSON()
    }

    %% Route Model
    class Route {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -String routeName*
        -String routeCode*
        -Object origin*
        -Object destination*
        -Array pickupPoints
        -Array dropoffPoints
        -Number distance*
        -Number estimatedDuration*
        -Boolean isActive
    }

    %% Bus Model
    class Bus {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -String busNumber*
        -Enum busType*
        -Number totalSeats*
        -Object seatLayout*
        -Array amenities
        -Array images
        -Boolean isActive
        -Enum maintenanceStatus
    }

    %% Trip Model
    class Trip {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -ObjectId routeId*
        -ObjectId busId*
        -String tripCode*
        -Date departureTime*
        -Date arrivalTime*
        -Number basePrice*
        -Number availableSeats*
        -Array occupiedSeats
        -Array lockedSeats
        -ObjectId driver
        -ObjectId tripManager
        -Enum status
        +isSeatAvailable()
        +lockSeats()
        +releaseLocks()
        +occupySeats()
    }

    %% Booking Model
    class Booking {
        <<MongoDB Model>>
        -ObjectId _id
        -String bookingCode*
        -ObjectId customerId*
        -ObjectId tripId*
        -ObjectId operatorId*
        -Array seats*
        -Object pickupPoint
        -Object dropoffPoint
        -Number subtotal*
        -Number discount
        -Number totalAmount*
        -ObjectId voucherId
        -String voucherCode
        -String contactEmail*
        -String contactPhone*
        -Enum status
        -Date cancelledAt
        -Number refundAmount
        -Array checkedInSeats
        +generateBookingCode()
    }

    %% Ticket Model
    class Ticket {
        <<MongoDB Model>>
        -ObjectId _id
        -String ticketCode*
        -ObjectId bookingId*
        -ObjectId customerId*
        -ObjectId tripId*
        -String seatNumber*
        -Object passenger*
        -String qrCode*
        -String qrData*
        -String ticketPDF
        -Boolean isValid
        -Boolean isUsed
        -Date usedAt
        -ObjectId validatedBy
        -Object tripDetails
        +generateTicketCode()
    }

    %% Payment Model
    class Payment {
        <<MongoDB Model>>
        -ObjectId _id
        -String transactionId*
        -ObjectId bookingId*
        -ObjectId customerId*
        -Number amount*
        -String currency
        -Enum paymentMethod*
        -String gatewayTransactionId
        -Mixed gatewayResponse
        -Enum status
        -Number refundAmount
        -Date refundedAt
        -String refundReason
        +generateTransactionId()
    }

    %% ========== NOT IMPLEMENTED MODELS (Dashed - Referenced) ==========

    class Staff {
        <<Not Implemented>>
        -ObjectId _id
        -ObjectId operatorId
        -String employeeCode
        -String fullName
        -Enum role
        -Enum status
    }

    class Voucher {
        <<Not Implemented>>
        -ObjectId _id
        -String code
        -Enum discountType
        -Number discountValue
        -ObjectId operatorId
    }

    %% ========== RELATIONSHIPS ==========

    %% User relationships
    User "1" -- "0..*" Booking : makes

    %% BusOperator relationships
    BusOperator "1" -- "0..*" Route : manages
    BusOperator "1" -- "0..*" Bus : owns
    BusOperator "1" -- "0..*" Trip : operates
    BusOperator "1" -- "0..*" Staff : employs

    %% Trip relationships
    Trip "1" -- "1" Route : follows
    Trip "1" -- "1" Bus : uses
    Trip "1" -- "0..1" Staff : has driver
    Trip "1" -- "0..1" Staff : has tripManager
    Trip "1" -- "0..*" Booking : has

    %% Booking relationships
    Booking "1" -- "1" Trip : for
    Booking "1" -- "1" User : by
    Booking "1" -- "1" BusOperator : with
    Booking "1" -- "0..1" Voucher : uses
    Booking "1" -- "1..*" Ticket : generates
    Booking "1" -- "1" Payment : has

    %% Payment relationships
    Payment "1" -- "1" Booking : for
    Payment "1" -- "1" User : by

    %% Ticket relationships
    Ticket "1" -- "1" Booking : from
    Ticket "1" -- "1" Trip : for
    Ticket "1" -- "0..1" Staff : validated by

    %% Styling
    style User fill:#90EE90
    style BusOperator fill:#90EE90
    style Route fill:#90EE90
    style Bus fill:#90EE90
    style Trip fill:#90EE90
    style Booking fill:#90EE90
    style Ticket fill:#90EE90
    style Payment fill:#90EE90
    style Staff fill:#FFB6C6,stroke-dasharray: 5 5
    style Voucher fill:#FFB6C6,stroke-dasharray: 5 5
```

**Ghi ch√∫ Class Diagram:**
- ‚úÖ **M√†u xanh l√° (solid):** Models ƒë√£ ƒë∆∞·ª£c implement trong `backend/src/models/`
- üî¥ **M√†u h·ªìng (dashed):** Models ch∆∞a implement nh∆∞ng ƒë∆∞·ª£c referenced trong code
- `*` = Required field
- Embedded documents (nh∆∞ `passenger`, `seatLayout`, `lockedSeats`) kh√¥ng ƒë∆∞·ª£c hi·ªÉn th·ªã ri√™ng v√¨ ƒë∆∞·ª£c nh√∫ng trong parent model

### 2.5 Quan H·ªá Gi·ªØa C√°c L·ªõp (D·ª±a Tr√™n Code Th·ª±c T·∫ø)

#### **2.5.1 Quan h·ªá Reference (ObjectId References)**

Trong MongoDB, c√°c models ƒë∆∞·ª£c li√™n k·∫øt th√¥ng qua ObjectId references:

**User Model:**
- `User` ‚Üê `Booking.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu bookings
- `User` ‚Üê `Payment.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu payments
- `User` ‚Üê `Ticket.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu tickets

**BusOperator Model:**
- `BusOperator` ‚Üê `Route.operatorId` (1:N) - M·ªôt nh√† xe qu·∫£n l√Ω nhi·ªÅu tuy·∫øn
- `BusOperator` ‚Üê `Bus.operatorId` (1:N) - M·ªôt nh√† xe s·ªü h·ªØu nhi·ªÅu xe
- `BusOperator` ‚Üê `Trip.operatorId` (1:N) - M·ªôt nh√† xe v·∫≠n h√†nh nhi·ªÅu chuy·∫øn
- `BusOperator` ‚Üê `Booking.operatorId` (1:N) - M·ªôt nh√† xe nh·∫≠n nhi·ªÅu bookings
- `BusOperator` ‚Üê `Staff.operatorId` (1:N) ‚ö†Ô∏è _Staff ch∆∞a implement_

**Route Model:**
- `Route` ‚Üê `Trip.routeId` (1:N) - M·ªôt tuy·∫øn c√≥ nhi·ªÅu chuy·∫øn

**Bus Model:**
- `Bus` ‚Üê `Trip.busId` (1:N) - M·ªôt xe th·ª±c hi·ªán nhi·ªÅu chuy·∫øn

**Trip Model:**
- `Trip` ‚Üê `Booking.tripId` (1:N) - M·ªôt chuy·∫øn c√≥ nhi·ªÅu bookings
- `Trip` ‚Üê `Ticket.tripId` (1:N) - M·ªôt chuy·∫øn c√≥ nhi·ªÅu tickets
- `Trip` ‚Üí `Staff (driver)` (N:1) ‚ö†Ô∏è _Staff ch∆∞a implement_
- `Trip` ‚Üí `Staff (tripManager)` (N:1) ‚ö†Ô∏è _Staff ch∆∞a implement_

**Booking Model:**
- `Booking` ‚Üê `Ticket.bookingId` (1:N) - M·ªôt booking t·∫°o nhi·ªÅu tickets
- `Booking` ‚Üê `Payment.bookingId` (1:1) - M·ªôt booking c√≥ m·ªôt payment
- `Booking` ‚Üí `Voucher.voucherId` (N:1) ‚ö†Ô∏è _Voucher ch∆∞a implement_
- `Booking` ‚Üí `Staff.checkedInBy` (N:1) ‚ö†Ô∏è _Staff ch∆∞a implement_

**Ticket Model:**
- `Ticket` ‚Üí `Staff.validatedBy` (N:1) ‚ö†Ô∏è _Staff ch∆∞a implement_

#### **2.5.2 Quan h·ªá Embedded (Nested Documents)**

C√°c documents ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp trong parent document (kh√¥ng ph·∫£i reference):

**User Model:**
- `savedPassengers`: Array of embedded { fullName, phone, idCard }

**BusOperator Model:**
- `address`: Embedded { street, ward, district, city, country }
- `bankAccount`: Embedded { bankName, accountNumber, accountHolder }

**Route Model:**
- `origin`: Embedded { city, province, station, address, coordinates }
- `destination`: Embedded { city, province, station, address, coordinates }
- `pickupPoints`: Array of embedded { name, address, coordinates }
- `dropoffPoints`: Array of embedded { name, address, coordinates }

**Bus Model:**
- `seatLayout`: Embedded { floors, rows, columns, layout }

**Trip Model:**
- `occupiedSeats`: Array of String
- `lockedSeats`: Array of embedded { seatNumber, lockedUntil, sessionId }

**Booking Model:**
- `seats`: Array of embedded { seatNumber, passenger: { fullName, phone, idCard } }
- `pickupPoint`: Embedded { name, address, coordinates }
- `dropoffPoint`: Embedded { name, address, coordinates }

**Ticket Model:**
- `passenger`: Embedded { fullName, phone, idCard }
- `tripDetails`: Embedded { routeName, origin, destination, departureTime, busNumber, operatorName }

**Payment Model:**
- `gatewayResponse`: Mixed (object ch·ª©a raw response t·ª´ payment gateway)

#### **2.5.3 ƒê·∫∑c ƒêi·ªÉm Thi·∫øt K·∫ø MongoDB**

**1. Denormalization (Phi chu·∫©n h√≥a):**
- `Ticket.tripDetails` ch·ª©a th√¥ng tin denormalized t·ª´ Trip, Route, Bus - Tr√°nh join khi hi·ªÉn th·ªã v√©
- `Booking.operatorId` duplicate t·ª´ Trip - Optimize query bookings by operator

**2. Embedded vs Referenced:**
- **Embedded:** D·ªØ li·ªáu kh√¥ng c·∫ßn query ri√™ng (passenger, seatLayout, lockedSeats)
- **Referenced:** D·ªØ li·ªáu c·∫ßn query ƒë·ªôc l·∫≠p ho·∫∑c ƒë∆∞·ª£c share (User, Trip, Bus, Route)

**3. Array Fields:**
- `occupiedSeats`, `lockedSeats`, `seats`, `pickupPoints` - Cho ph√©p query linh ho·∫°t
- Indexes ƒë∆∞·ª£c t·∫°o tr√™n c√°c array fields quan tr·ªçng

---

## 3. S∆† ƒê·ªí LU·ªíNG HO·∫†T ƒê·ªòNG

### 3.1 Sequence Diagrams (S∆° ƒê·ªì Tu·∫ßn T·ª±)

#### **3.1.1 UC-5: ƒê·∫∑t V√©**

```mermaid
sequenceDiagram
    actor User
    participant UI as Web UI
    participant BookingCtrl as Booking Controller
    participant TripService as Trip Service
    participant SeatLockService as Seat Lock Service
    participant DB as Database
    participant Cache as Redis Cache

    User->>UI: Ch·ªçn chuy·∫øn xe
    UI->>TripService: getTripDetails(tripId)
    TripService->>DB: Query trip & available seats
    DB-->>TripService: Trip data
    TripService-->>UI: Hi·ªÉn th·ªã s∆° ƒë·ªì gh·∫ø

    User->>UI: Ch·ªçn gh·∫ø (max 6)
    UI->>SeatLockService: lockSeats(tripId, seats, userId)
    SeatLockService->>Cache: SET seat_lock with TTL 15min
    Cache-->>SeatLockService: Lock created
    SeatLockService->>DB: Create SeatLock records
    SeatLockService-->>UI: Gh·∫ø ƒë√£ kh√≥a

    User->>UI: Nh·∫≠p th√¥ng tin h√†nh kh√°ch
    User->>UI: Ch·ªçn ƒëi·ªÉm ƒë√≥n/tr·∫£
    User->>UI: Nh·∫≠p voucher (optional)
    UI->>BookingCtrl: validateVoucher(code)
    BookingCtrl->>DB: Query voucher
    DB-->>BookingCtrl: Voucher data
    BookingCtrl-->>UI: Voucher h·ª£p l·ªá, √°p d·ª•ng gi·∫£m gi√°

    User->>UI: X√°c nh·∫≠n ƒë·∫∑t v√©
    UI->>BookingCtrl: createBooking(tripId, passengers, seats, voucher)
    BookingCtrl->>DB: Create Booking (status: pending)
    DB-->>BookingCtrl: Booking created
    BookingCtrl-->>UI: BookingId, chuy·ªÉn sang thanh to√°n

    alt Timeout sau 15 ph√∫t
        SeatLockService->>Cache: Check expired locks
        Cache-->>SeatLockService: Expired locks
        SeatLockService->>DB: Delete expired SeatLock
        SeatLockService->>DB: Update Booking status to cancelled
    end
```

#### **3.1.2 UC-6: Thanh To√°n**

```mermaid
sequenceDiagram
    actor User
    participant UI as Web UI
    participant PaymentCtrl as Payment Controller
    participant PaymentGateway as Payment Gateway
    participant BookingService as Booking Service
    participant TicketService as Ticket Service
    participant NotificationService as Notification Service
    participant DB as Database

    User->>UI: Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
    UI->>PaymentCtrl: initiatePayment(bookingId, method)
    PaymentCtrl->>DB: Create Payment (status: pending)
    PaymentCtrl->>PaymentGateway: createPaymentUrl(amount, bookingId)
    PaymentGateway-->>PaymentCtrl: Payment URL
    PaymentCtrl-->>UI: Redirect to Payment Gateway

    UI->>PaymentGateway: User pays
    User->>PaymentGateway: Nh·∫≠p th√¥ng tin thanh to√°n
    PaymentGateway->>PaymentGateway: Process payment

    alt Thanh to√°n th√†nh c√¥ng
        PaymentGateway->>PaymentCtrl: Callback (success, transactionId)
        PaymentCtrl->>DB: Update Payment (status: success)
        PaymentCtrl->>BookingService: confirmBooking(bookingId)
        BookingService->>DB: Update Booking (status: confirmed)
        BookingService->>TicketService: generateTickets(bookingId)
        TicketService->>TicketService: Generate QR codes
        TicketService->>DB: Create Ticket records
        TicketService->>TicketService: Generate PDF tickets
        TicketService-->>BookingService: Tickets created
        BookingService->>NotificationService: sendTickets(email, tickets)
        NotificationService->>User: Email v√© ƒëi·ªán t·ª≠ + QR
        NotificationService->>User: SMS link t·∫£i v√©
        PaymentCtrl-->>UI: Redirect to success page
    else Thanh to√°n th·∫•t b·∫°i
        PaymentGateway->>PaymentCtrl: Callback (failed)
        PaymentCtrl->>DB: Update Payment (status: failed)
        PaymentCtrl-->>UI: Redirect to failure page
        UI-->>User: Cho ph√©p th·ª≠ l·∫°i (10 ph√∫t)
    end
```

#### **3.1.3 UC-19: Qu√©t QR X√°c Th·ª±c V√©**

```mermaid
sequenceDiagram
    actor TripManager
    participant MobileUI as Web UI (Mobile)
    participant VerifyCtrl as Verify Controller
    participant TicketService as Ticket Service
    participant TripService as Trip Service
    participant DB as Database

    TripManager->>MobileUI: M·ªü camera qu√©t QR
    MobileUI->>MobileUI: Scan QR code
    MobileUI->>VerifyCtrl: verifyTicket(qrCode, tripId)

    VerifyCtrl->>VerifyCtrl: Decrypt QR code
    VerifyCtrl->>TicketService: getTicketInfo(ticketId)
    TicketService->>DB: Query Ticket + Booking + Passenger
    DB-->>TicketService: Ticket data

    TicketService->>TicketService: Validate ticket

    alt V√© h·ª£p l·ªá
        TicketService->>TripService: checkTripMatch(ticketTripId, currentTripId)
        alt ƒê√∫ng chuy·∫øn
            TicketService-->>VerifyCtrl: Valid ticket
            VerifyCtrl-->>MobileUI: Hi·ªÉn th·ªã th√¥ng tin h√†nh kh√°ch
            TripManager->>MobileUI: X√°c nh·∫≠n h√†nh kh√°ch l√™n xe
            MobileUI->>TicketService: markTicketAsUsed(ticketId)
            TicketService->>DB: Update Ticket (isUsed: true, usedAt: now)
            DB-->>TicketService: Updated
            TicketService-->>MobileUI: Th√†nh c√¥ng
            MobileUI-->>TripManager: V√© ƒë√£ x√°c th·ª±c
        else Sai chuy·∫øn
            TripService-->>VerifyCtrl: Wrong trip
            VerifyCtrl-->>MobileUI: C·∫£nh b√°o: V√© kh√¥ng ƒë√∫ng chuy·∫øn
        end
    else V√© kh√¥ng h·ª£p l·ªá
        alt V√© ƒë√£ s·ª≠ d·ª•ng
            TicketService-->>VerifyCtrl: Already used
            VerifyCtrl-->>MobileUI: C·∫£nh b√°o: V√© ƒë√£ qu√©t l√∫c [usedAt]
        else V√© ƒë√£ h·ªßy
            TicketService-->>VerifyCtrl: Cancelled
            VerifyCtrl-->>MobileUI: C·∫£nh b√°o: V√© ƒë√£ b·ªã h·ªßy
        else V√© gi·∫£/h·∫øt h·∫°n
            TicketService-->>VerifyCtrl: Invalid
            VerifyCtrl-->>MobileUI: C·∫£nh b√°o: V√© kh√¥ng h·ª£p l·ªá
        end
    end
```

#### **3.1.4 UC-14: T·∫°o L·ªãch Tr√¨nh Chuy·∫øn Xe**

```mermaid
sequenceDiagram
    actor BusOperator
    participant AdminUI as Admin UI
    participant TripCtrl as Trip Controller
    participant RouteService as Route Service
    participant BusService as Bus Service
    participant StaffService as Staff Service
    participant DB as Database

    BusOperator->>AdminUI: Truy c·∫≠p trang t·∫°o l·ªãch tr√¨nh
    AdminUI->>RouteService: getOperatorRoutes(operatorId)
    RouteService->>DB: Query routes
    DB-->>AdminUI: Danh s√°ch tuy·∫øn

    AdminUI->>BusService: getAvailableBuses(operatorId)
    BusService->>DB: Query buses (status: active)
    DB-->>AdminUI: Danh s√°ch xe

    AdminUI->>StaffService: getStaffList(operatorId)
    StaffService->>DB: Query staff
    DB-->>AdminUI: Danh s√°ch nh√¢n vi√™n

    BusOperator->>AdminUI: Ch·ªçn tuy·∫øn, xe, t√†i x·∫ø, manager
    BusOperator->>AdminUI: Nh·∫≠p gi·ªù kh·ªüi h√†nh, gi√° v√©
    BusOperator->>AdminUI: Ch·ªçn l·ªãch l·∫∑p l·∫°i (optional)

    AdminUI->>TripCtrl: createTrip(tripData)
    TripCtrl->>StaffService: checkStaffAvailability(driverId, time)
    StaffService->>DB: Query existing trips
    DB-->>StaffService: Staff assignments

    alt T√†i x·∫ø/xe b·ªã tr√πng
        StaffService-->>TripCtrl: Conflict detected
        TripCtrl-->>AdminUI: C·∫£nh b√°o xung ƒë·ªôt
        AdminUI-->>BusOperator: Y√™u c·∫ßu ch·ªçn l·∫°i
    else Kh√¥ng tr√πng
        StaffService-->>TripCtrl: Available
        TripCtrl->>DB: Create Trip(s)
        alt L·∫∑p l·∫°i h√†ng ng√†y/tu·∫ßn
            TripCtrl->>TripCtrl: Generate recurring trips
            TripCtrl->>DB: Bulk insert trips
        end
        DB-->>TripCtrl: Trips created
        TripCtrl-->>AdminUI: Th√†nh c√¥ng
        AdminUI-->>BusOperator: L·ªãch tr√¨nh ƒë√£ t·∫°o
    end
```

### 3.2 Activity Diagrams (S∆° ƒê·ªì Ho·∫°t ƒê·ªông)

#### **3.2.1 Quy Tr√¨nh ƒê·∫∑t V√© Ho√†n Ch·ªânh (End-to-End)**

```mermaid
flowchart TD
    Start([B·∫Øt ƒë·∫ßu]) --> A[T√¨m ki·∫øm chuy·∫øn xe]
    A --> B{C√≥ chuy·∫øn?}
    B -->|Kh√¥ng| C[G·ª£i √Ω ng√†y kh√°c]
    C --> A
    B -->|C√≥| D[Xem danh s√°ch chuy·∫øn]
    D --> E[Ch·ªçn chuy·∫øn xem chi ti·∫øt]
    E --> F[Xem s∆° ƒë·ªì gh·∫ø]
    F --> G[Ch·ªçn gh·∫ø < 6]
    G --> H{Gh·∫ø c√≤n tr·ªëng?}
    H -->|Kh√¥ng| I[C·∫≠p nh·∫≠t s∆° ƒë·ªì real-time]
    I --> F
    H -->|C√≥| J[Lock gh·∫ø 15 ph√∫t]
    J --> K[Nh·∫≠p th√¥ng tin h√†nh kh√°ch]
    K --> L[Ch·ªçn ƒëi·ªÉm ƒë√≥n/tr·∫£]
    L --> M{C√≥ voucher?}
    M -->|C√≥| N[Nh·∫≠p m√£ voucher]
    N --> O{Voucher h·ª£p l·ªá?}
    O -->|Kh√¥ng| P[Th√¥ng b√°o l·ªói]
    P --> M
    O -->|C√≥| Q[√Åp d·ª•ng gi·∫£m gi√°]
    M -->|Kh√¥ng| R[X√°c nh·∫≠n th√¥ng tin]
    Q --> R
    R --> S[T·∫°o booking t·∫°m]
    S --> T[Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n]
    T --> U{Thanh to√°n th√†nh c√¥ng?}
    U -->|Kh√¥ng| V{C√≤n th·ªùi gian?}
    V -->|C√≥| W[Th·ª≠ l·∫°i thanh to√°n]
    W --> U
    V -->|Kh√¥ng| X[H·ªßy booking, release gh·∫ø]
    X --> End1([K·∫øt th√∫c - Th·∫•t b·∫°i])
    U -->|C√≥| Y[X√°c nh·∫≠n booking]
    Y --> Z[T·∫°o v√© ƒëi·ªán t·ª≠ + QR]
    Z --> AA[G·ª≠i email v√©]
    AA --> AB[G·ª≠i SMS link t·∫£i v√©]
    AB --> AC[L∆∞u v√†o l·ªãch s·ª≠]
    AC --> End2([K·∫øt th√∫c - Th√†nh c√¥ng])

    style Start fill:#90EE90
    style End1 fill:#FFB6C6
    style End2 fill:#90EE90
```

#### **3.2.2 Quy Tr√¨nh H·ªßy V√©**

```mermaid
flowchart TD
    Start([Kh√°ch h√†ng mu·ªën h·ªßy v√©]) --> A{ƒê√£ ƒëƒÉng nh·∫≠p?}
    A -->|Customer| B[V√†o Dashboard qu·∫£n l√Ω v√©]
    A -->|Guest| C[Tra c·ª©u v√© b·∫±ng Email/SƒêT + OTP]
    C --> D[Nh·∫≠p OTP]
    D --> E{OTP ƒë√∫ng?}
    E -->|Kh√¥ng| F[Th√¥ng b√°o l·ªói, th·ª≠ l·∫°i]
    F --> D
    E -->|C√≥| G[Hi·ªÉn th·ªã danh s√°ch v√©]
    B --> G
    G --> H[Ch·ªçn v√© c·∫ßn h·ªßy]
    H --> I[Ki·ªÉm tra ch√≠nh s√°ch h·ªßy]
    I --> J{Trong th·ªùi h·∫°n?}
    J -->|Kh√¥ng| K[Th√¥ng b√°o: Qu√° th·ªùi h·∫°n h·ªßy]
    K --> End1([K·∫øt th√∫c - Kh√¥ng th·ªÉ h·ªßy])
    J -->|C√≥| L[T√≠nh ph√≠ h·ªßy v√† s·ªë ti·ªÅn ho√†n]
    L --> M[Hi·ªÉn th·ªã chi ti·∫øt ho√†n ti·ªÅn]
    M --> N{X√°c nh·∫≠n h·ªßy?}
    N -->|Kh√¥ng| End2([K·∫øt th√∫c - Gi·ªØ v√©])
    N -->|C√≥| O[C·∫≠p nh·∫≠t tr·∫°ng th√°i v√©: cancelled]
    O --> P[C·∫≠p nh·∫≠t tr·∫°ng th√°i booking: cancelled]
    P --> Q[Release gh·∫ø ƒë√£ ƒë·∫∑t]
    Q --> R[T·∫°o giao d·ªãch ho√†n ti·ªÅn]
    R --> S[X·ª≠ l√Ω ho√†n ti·ªÅn qua Payment Gateway]
    S --> T{Ho√†n ti·ªÅn th√†nh c√¥ng?}
    T -->|Kh√¥ng| U[Ghi log l·ªói, retry sau]
    U --> S
    T -->|C√≥| V[G·ª≠i email x√°c nh·∫≠n h·ªßy v√©]
    V --> W[G·ª≠i SMS th√¥ng b√°o]
    W --> End3([K·∫øt th√∫c - H·ªßy th√†nh c√¥ng])

    style Start fill:#90EE90
    style End1 fill:#FFB6C6
    style End2 fill:#FFD700
    style End3 fill:#90EE90
```

#### **3.2.3 Quy Tr√¨nh So√°t V√©**

```mermaid
flowchart TD
    Start([Trip Manager so√°t v√©]) --> A[ƒêƒÉng nh·∫≠p h·ªá th·ªëng]
    A --> B[Ch·ªçn chuy·∫øn ƒë∆∞·ª£c ph√¢n c√¥ng]
    B --> C[Xem danh s√°ch h√†nh kh√°ch]
    C --> D[Qu√©t QR code v√©]
    D --> E[Gi·∫£i m√£ QR]
    E --> F{QR h·ª£p l·ªá?}
    F -->|Kh√¥ng| G[C·∫£nh b√°o: QR kh√¥ng h·ª£p l·ªá/gi·∫£]
    G --> H{Th·ª≠ l·∫°i?}
    H -->|C√≥| D
    H -->|Kh√¥ng| End1([K·∫øt th√∫c - T·ª´ ch·ªëi])
    F -->|C√≥| I[Truy v·∫•n th√¥ng tin v√©]
    I --> J{V√© ƒë√£ h·ªßy?}
    J -->|C√≥| K[C·∫£nh b√°o: V√© ƒë√£ b·ªã h·ªßy]
    K --> End1
    J -->|Kh√¥ng| L{V√© ƒë√£ s·ª≠ d·ª•ng?}
    L -->|C√≥| M[C·∫£nh b√°o: V√© ƒë√£ qu√©t l√∫c XX:XX]
    M --> End1
    L -->|Kh√¥ng| N{ƒê√∫ng chuy·∫øn?}
    N -->|Kh√¥ng| O[C·∫£nh b√°o: V√© kh√¥ng ƒë√∫ng chuy·∫øn]
    O --> End1
    N -->|C√≥| P[Hi·ªÉn th·ªã th√¥ng tin h√†nh kh√°ch]
    P --> Q[Hi·ªÉn th·ªã: H·ªç t√™n, gh·∫ø, ƒëi·ªÉm ƒë√≥n/tr·∫£]
    Q --> R{X√°c nh·∫≠n l√™n xe?}
    R -->|Kh√¥ng| End2([K·∫øt th√∫c - Ch∆∞a l√™n xe])
    R -->|C√≥| S[ƒê√°nh d·∫•u v√©: isUsed = true]
    S --> T[L∆∞u th·ªùi gian: usedAt = now]
    T --> U[C·∫≠p nh·∫≠t danh s√°ch h√†nh kh√°ch]
    U --> V[Hi·ªÉn th·ªã: ƒê√£ so√°t v√© th√†nh c√¥ng]
    V --> W{C√≤n h√†nh kh√°ch?}
    W -->|C√≥| D
    W -->|Kh√¥ng| X[C·∫≠p nh·∫≠t tr·∫°ng th√°i chuy·∫øn: ongoing]
    X --> End3([K·∫øt th√∫c - Ho√†n th√†nh so√°t v√©])

    style Start fill:#90EE90
    style End1 fill:#FFB6C6
    style End2 fill:#FFD700
    style End3 fill:#90EE90
```

#### **3.2.4 Quy Tr√¨nh Duy·ªát Nh√† Xe M·ªõi**

```mermaid
flowchart TD
    Start([Nh√† xe ƒëƒÉng k√Ω]) --> A[ƒêi·ªÅn form ƒëƒÉng k√Ω]
    A --> B[Upload gi·∫•y ph√©p kinh doanh]
    B --> C[Upload gi·∫•y t·ªù ph√°p l√Ω]
    C --> D[Nh·∫≠p th√¥ng tin ng√¢n h√†ng]
    D --> E[Submit ƒëƒÉng k√Ω]
    E --> F[T·∫°o BusOperator: status = pending]
    F --> G[G·ª≠i email x√°c nh·∫≠n nh·∫≠n ƒë∆°n]
    G --> H[Th√¥ng b√°o cho Admin]

    H --> I[Admin xem danh s√°ch ƒëƒÉng k√Ω]
    I --> J[Ch·ªçn ƒë∆°n ƒëƒÉng k√Ω]
    J --> K[Xem chi ti·∫øt th√¥ng tin]
    K --> L[Ki·ªÉm tra gi·∫•y t·ªù]
    L --> M{Gi·∫•y t·ªù h·ª£p l·ªá?}
    M -->|Kh√¥ng| N[T·ª´ ch·ªëi ƒëƒÉng k√Ω]
    N --> O[Nh·∫≠p l√Ω do t·ª´ ch·ªëi]
    O --> P[C·∫≠p nh·∫≠t: status = rejected]
    P --> Q[G·ª≠i email th√¥ng b√°o t·ª´ ch·ªëi]
    Q --> End1([K·∫øt th√∫c - T·ª´ ch·ªëi])

    M -->|C√≥| R[X√°c th·ª±c gi·∫•y ph√©p]
    R --> S[Ki·ªÉm tra th√¥ng tin c√¥ng ty]
    S --> T{Th√¥ng tin ch√≠nh x√°c?}
    T -->|Kh√¥ng| N
    T -->|C√≥| U[Ph√™ duy·ªát ƒëƒÉng k√Ω]
    U --> V[C·∫≠p nh·∫≠t: status = verified]
    V --> W[T·∫°o t√†i kho·∫£n ƒëƒÉng nh·∫≠p]
    W --> X[G·ª≠i email ch√†o m·ª´ng + th√¥ng tin ƒëƒÉng nh·∫≠p]
    X --> Y[K√≠ch ho·∫°t dashboard nh√† xe]
    Y --> End2([K·∫øt th√∫c - Ph√™ duy·ªát])

    style Start fill:#90EE90
    style End1 fill:#FFB6C6
    style End2 fill:#90EE90
```

### 3.3 State Diagrams (S∆° ƒê·ªì Tr·∫°ng Th√°i)

#### **3.3.1 Tr·∫°ng Th√°i Booking**

```mermaid
stateDiagram-v2
    [*] --> Pending: T·∫°o booking
    Pending --> Confirmed: Thanh to√°n th√†nh c√¥ng
    Pending --> Cancelled: H·∫øt th·ªùi gian / Thanh to√°n th·∫•t b·∫°i
    Confirmed --> Cancelled: H·ªßy v√©
    Confirmed --> Completed: Ho√†n th√†nh chuy·∫øn ƒëi
    Confirmed --> Changed: ƒê·ªïi v√© (t·∫°o booking m·ªõi)
    Cancelled --> [*]: End
    Completed --> [*]: End
    Changed --> [*]: End

    note right of Pending
        Th·ªùi gian t·ªìn t·∫°i: 15 ph√∫t
        (seat lock duration)
    end note

    note right of Confirmed
        C√≥ th·ªÉ h·ªßy/ƒë·ªïi trong
        th·ªùi h·∫°n cho ph√©p
    end note
```

#### **3.3.2 Tr·∫°ng Th√°i Ticket**

```mermaid
stateDiagram-v2
    [*] --> Valid: T·∫°o v√© sau khi thanh to√°n
    Valid --> Used: Qu√©t QR l√™n xe
    Valid --> Cancelled: H·ªßy v√©
    Valid --> Expired: Qu√° gi·ªù kh·ªüi h√†nh
    Used --> [*]: End
    Cancelled --> [*]: End
    Expired --> [*]: End

    note right of Valid
        V√© h·ª£p l·ªá, ch∆∞a s·ª≠ d·ª•ng
        QR code c√≥ th·ªÉ qu√©t
    end note

    note right of Used
        isUsed = true
        usedAt = timestamp
        Kh√¥ng th·ªÉ qu√©t l·∫°i
    end note
```

#### **3.3.3 Tr·∫°ng Th√°i Trip**

```mermaid
stateDiagram-v2
    [*] --> Scheduled: T·∫°o l·ªãch tr√¨nh
    Scheduled --> Ongoing: B·∫Øt ƒë·∫ßu chuy·∫øn (c·∫≠p nh·∫≠t b·ªüi Trip Manager)
    Scheduled --> Cancelled: H·ªßy chuy·∫øn (b·ªüi Operator)
    Ongoing --> Completed: Ho√†n th√†nh chuy·∫øn
    Ongoing --> Cancelled: H·ªßy chuy·∫øn gi·ªØa ch·ª´ng (kh·∫©n c·∫•p)
    Completed --> [*]: End
    Cancelled --> [*]: End

    note right of Scheduled
        Chuy·∫øn ƒë√£ t·∫°o, ch·ªù kh·ªüi h√†nh
        C√≥ th·ªÉ booking v√©
    end note

    note right of Ongoing
        Chuy·∫øn ƒëang di·ªÖn ra
        Kh√¥ng th·ªÉ booking
    end note
```

#### **3.3.4 Tr·∫°ng Th√°i Payment**

```mermaid
stateDiagram-v2
    [*] --> Pending: Kh·ªüi t·∫°o thanh to√°n
    Pending --> Success: Payment Gateway confirm
    Pending --> Failed: Payment Gateway reject
    Success --> Refunded: Ho√†n ti·ªÅn (do h·ªßy v√©)
    Failed --> Pending: Retry (trong 10 ph√∫t)
    Success --> [*]: End
    Failed --> [*]: End (after timeout)
    Refunded --> [*]: End

    note right of Pending
        Ch·ªù x√°c nh·∫≠n t·ª´
        Payment Gateway
    end note

    note right of Refunded
        Ho√†n ti·ªÅn t·ª± ƒë·ªông
        qua Payment Gateway
    end note
```

---

## 4. THI·∫æT K·∫æ KI·∫æN TR√öC H·ªÜ TH·ªêNG

### 4.1 T·ªïng Quan Ki·∫øn Tr√∫c

H·ªá th·ªëng √°p d·ª•ng ki·∫øn tr√∫c **3-tier** k·∫øt h·ª£p v·ªõi **Microservices** cho c√°c service quan tr·ªçng:

- **Presentation Layer:** React SPA + Mobile-responsive Web
- **Application Layer:** RESTful API (Node.js + Express)
- **Data Layer:** MongoDB + Redis Cache

### 4.2 System Architecture Diagram

```mermaid
graph TB
    subgraph "Client Layer"
        WEB[Web Browser - React SPA]
        MOBILE[Mobile Browser]
    end

    subgraph "CDN & Load Balancer"
        CDN[CloudFlare CDN]
        LB[Load Balancer - Nginx]
    end

    subgraph "Application Layer"
        subgraph "API Gateway"
            GATEWAY[API Gateway<br/>- Authentication<br/>- Rate Limiting<br/>- Routing]
        end

        subgraph "Core Services"
            AUTH[Auth Service<br/>- Login/Register<br/>- JWT Token<br/>- OAuth]
            BOOKING[Booking Service<br/>- Search Trips<br/>- Create Booking<br/>- Seat Locking]
            PAYMENT[Payment Service<br/>- Process Payment<br/>- Refund<br/>- Invoice]
            TICKET[Ticket Service<br/>- Generate QR<br/>- Verify Ticket<br/>- PDF Generation]
            NOTIFICATION[Notification Service<br/>- Email Queue<br/>- SMS Queue<br/>- Push Notification]
            OPERATOR[Operator Service<br/>- Manage Routes<br/>- Manage Buses<br/>- Reports]
            ADMIN[Admin Service<br/>- User Management<br/>- Content Management<br/>- Analytics]
        end
    end

    subgraph "Data Layer"
        subgraph "Primary Database"
            MONGODB[(MongoDB<br/>Main Database)]
        end

        subgraph "Cache Layer"
            REDIS[(Redis<br/>- Session Store<br/>- Seat Lock Cache<br/>- Rate Limit)]
        end

        subgraph "Queue"
            QUEUE[Redis Queue<br/>- Email Jobs<br/>- SMS Jobs<br/>- Report Jobs]
        end

        subgraph "File Storage"
            S3[AWS S3 / Cloud Storage<br/>- Ticket PDFs<br/>- Images<br/>- Documents]
        end
    end

    subgraph "External Services"
        PAYMENT_GW[Payment Gateways<br/>- VNPay<br/>- MoMo<br/>- ZaloPay]
        EMAIL_SVC[Email Service<br/>- SendGrid<br/>- AWS SES]
        SMS_SVC[SMS Service<br/>- VNPT SMS<br/>- Viettel SMS]
    end

    WEB --> CDN
    MOBILE --> CDN
    CDN --> LB
    LB --> GATEWAY

    GATEWAY --> AUTH
    GATEWAY --> BOOKING
    GATEWAY --> PAYMENT
    GATEWAY --> TICKET
    GATEWAY --> NOTIFICATION
    GATEWAY --> OPERATOR
    GATEWAY --> ADMIN

    AUTH --> MONGODB
    AUTH --> REDIS
    BOOKING --> MONGODB
    BOOKING --> REDIS
    PAYMENT --> MONGODB
    TICKET --> MONGODB
    TICKET --> S3
    NOTIFICATION --> QUEUE
    OPERATOR --> MONGODB
    ADMIN --> MONGODB

    QUEUE --> EMAIL_SVC
    QUEUE --> SMS_SVC
    PAYMENT --> PAYMENT_GW

    style WEB fill:#E3F2FD
    style MOBILE fill:#E3F2FD
    style GATEWAY fill:#FFF9C4
    style MONGODB fill:#C8E6C9
    style REDIS fill:#FFCCBC
```

### 4.3 Component Diagram (S∆° ƒê·ªì Th√†nh Ph·∫ßn)

```mermaid
graph TB
    subgraph "Frontend Components"
        subgraph "Customer App"
            SEARCH[Search & Filter]
            BOOKING_UI[Booking Flow]
            PAYMENT_UI[Payment UI]
            DASHBOARD[User Dashboard]
            REVIEW_UI[Review & Rating]
        end

        subgraph "Operator Admin"
            OP_DASH[Operator Dashboard]
            ROUTE_MGMT[Route Management]
            BUS_MGMT[Bus Management]
            SCHEDULE_MGMT[Schedule Management]
            STAFF_MGMT[Staff Management]
            REPORT[Revenue Reports]
        end

        subgraph "Trip Manager App"
            QR_SCANNER[QR Scanner]
            PASSENGER_LIST[Passenger List]
            TRIP_STATUS[Trip Status]
        end

        subgraph "System Admin"
            SYS_DASH[System Dashboard]
            USER_MGMT[User Management]
            APPROVAL[Operator Approval]
            CONTENT_MGMT[Content Management]
            ANALYTICS[Analytics & Reports]
        end
    end

    subgraph "Backend Components"
        subgraph "Core Modules"
            AUTH_MODULE[Authentication Module<br/>- JWT<br/>- OAuth<br/>- Session]
            BOOKING_MODULE[Booking Module<br/>- Search Engine<br/>- Seat Lock Manager<br/>- Price Calculator]
            PAYMENT_MODULE[Payment Module<br/>- Gateway Integration<br/>- Transaction Manager<br/>- Refund Handler]
            TICKET_MODULE[Ticket Module<br/>- QR Generator<br/>- PDF Generator<br/>- Verification Engine]
        end

        subgraph "Supporting Modules"
            NOTIFICATION_MODULE[Notification Module<br/>- Email Sender<br/>- SMS Sender<br/>- Template Engine]
            REPORT_MODULE[Report Module<br/>- Data Aggregator<br/>- Export Engine]
            CACHE_MODULE[Cache Module<br/>- Redis Manager<br/>- TTL Controller]
            FILE_MODULE[File Module<br/>- Upload Handler<br/>- S3 Integration]
        end
    end

    subgraph "Data Access Layer"
        USER_REPO[User Repository]
        BOOKING_REPO[Booking Repository]
        TRIP_REPO[Trip Repository]
        PAYMENT_REPO[Payment Repository]
        OPERATOR_REPO[Operator Repository]
    end

    SEARCH --> BOOKING_MODULE
    BOOKING_UI --> BOOKING_MODULE
    PAYMENT_UI --> PAYMENT_MODULE
    DASHBOARD --> AUTH_MODULE
    REVIEW_UI --> BOOKING_MODULE

    OP_DASH --> OPERATOR_REPO
    ROUTE_MGMT --> OPERATOR_REPO
    BUS_MGMT --> OPERATOR_REPO
    SCHEDULE_MGMT --> TRIP_REPO
    STAFF_MGMT --> OPERATOR_REPO
    REPORT --> REPORT_MODULE

    QR_SCANNER --> TICKET_MODULE
    PASSENGER_LIST --> TRIP_REPO
    TRIP_STATUS --> TRIP_REPO

    SYS_DASH --> ANALYTICS
    USER_MGMT --> USER_REPO
    APPROVAL --> OPERATOR_REPO
    CONTENT_MGMT --> FILE_MODULE

    BOOKING_MODULE --> BOOKING_REPO
    BOOKING_MODULE --> CACHE_MODULE
    PAYMENT_MODULE --> PAYMENT_REPO
    TICKET_MODULE --> FILE_MODULE
    NOTIFICATION_MODULE --> NOTIFICATION_MODULE

    style AUTH_MODULE fill:#FFE082
    style BOOKING_MODULE fill:#FFE082
    style PAYMENT_MODULE fill:#FFE082
    style TICKET_MODULE fill:#FFE082
```

### 4.4 Deployment Diagram (S∆° ƒê·ªì Tri·ªÉn Khai)

```mermaid
graph TB
    subgraph "User Devices"
        DESKTOP[Desktop Browser]
        TABLET[Tablet Browser]
        PHONE[Mobile Browser]
    end

    subgraph "CDN - CloudFlare"
        CDN_EDGE[Edge Servers<br/>Static Assets]
    end

    subgraph "Cloud Infrastructure - AWS/Azure"
        subgraph "Load Balancer Zone"
            ALB[Application Load Balancer<br/>Nginx]
        end

        subgraph "Web Server Zone - Auto Scaling"
            WEB1[Web Server 1<br/>React Build<br/>Nginx]
            WEB2[Web Server 2<br/>React Build<br/>Nginx]
            WEB3[Web Server 3<br/>React Build<br/>Nginx]
        end

        subgraph "Application Server Zone - Auto Scaling"
            APP1[App Server 1<br/>Node.js + Express<br/>Docker Container]
            APP2[App Server 2<br/>Node.js + Express<br/>Docker Container]
            APP3[App Server 3<br/>Node.js + Express<br/>Docker Container]
        end

        subgraph "Database Zone"
            MONGO_PRIMARY[(MongoDB Primary)]
            MONGO_SECONDARY1[(MongoDB Secondary 1)]
            MONGO_SECONDARY2[(MongoDB Secondary 2)]
        end

        subgraph "Cache Zone"
            REDIS_MASTER[(Redis Master)]
            REDIS_REPLICA[(Redis Replica)]
        end

        subgraph "Queue Zone"
            QUEUE_WORKER[Queue Worker<br/>Bull/BullMQ]
        end

        subgraph "Storage Zone"
            S3_BUCKET[S3 Bucket<br/>PDF, Images]
        end
    end

    subgraph "External Services"
        VNPAY[VNPay Gateway]
        MOMO[MoMo Gateway]
        SENDGRID[SendGrid Email]
        VNPT_SMS[VNPT SMS]
    end

    DESKTOP --> CDN_EDGE
    TABLET --> CDN_EDGE
    PHONE --> CDN_EDGE

    CDN_EDGE --> ALB
    ALB --> WEB1
    ALB --> WEB2
    ALB --> WEB3

    WEB1 --> APP1
    WEB2 --> APP2
    WEB3 --> APP3

    APP1 --> MONGO_PRIMARY
    APP2 --> MONGO_PRIMARY
    APP3 --> MONGO_PRIMARY

    MONGO_PRIMARY --> MONGO_SECONDARY1
    MONGO_PRIMARY --> MONGO_SECONDARY2

    APP1 --> REDIS_MASTER
    APP2 --> REDIS_MASTER
    APP3 --> REDIS_MASTER

    REDIS_MASTER --> REDIS_REPLICA

    APP1 --> QUEUE_WORKER
    APP2 --> QUEUE_WORKER
    APP3 --> QUEUE_WORKER

    QUEUE_WORKER --> SENDGRID
    QUEUE_WORKER --> VNPT_SMS

    APP1 --> S3_BUCKET
    APP2 --> S3_BUCKET
    APP3 --> S3_BUCKET

    APP1 --> VNPAY
    APP2 --> MOMO

    style MONGO_PRIMARY fill:#4CAF50
    style REDIS_MASTER fill:#FF9800
    style APP1 fill:#2196F3
    style APP2 fill:#2196F3
    style APP3 fill:#2196F3
```

### 4.5 Database Schema (ERD - Implemented Models Only)

> **Ch√∫ th√≠ch:** ERD n√†y ch·ªâ hi·ªÉn th·ªã c√°c collections ƒê√É ƒê∆Ø·ª¢C IMPLEMENT trong MongoDB. C√°c quan h·ªá ƒë∆∞·ª£c th·ª±c hi·ªán th√¥ng qua ObjectId references v√† embedded documents.

```mermaid
erDiagram
    %% ========== IMPLEMENTED COLLECTIONS ==========

    USER {
        ObjectId _id PK
        String email UK
        String phone UK
        String password
        String fullName
        Enum role
        Array savedPassengers
        Enum loyaltyTier
        Number totalPoints
        Boolean isActive
        DateTime createdAt
        DateTime updatedAt
    }

    BUS_OPERATOR {
        ObjectId _id PK
        String companyName UK
        String email UK
        String businessLicense
        String taxCode
        Object address
        Object bankAccount
        Enum verificationStatus
        Number averageRating
        Number totalRevenue
        Boolean isActive
        DateTime createdAt
        DateTime updatedAt
    }

    ROUTE {
        ObjectId _id PK
        ObjectId operatorId FK
        String routeCode UK
        String routeName
        Object origin
        Object destination
        Array pickupPoints
        Array dropoffPoints
        Number distance
        Number estimatedDuration
        Boolean isActive
    }

    BUS {
        ObjectId _id PK
        ObjectId operatorId FK
        String busNumber UK
        Enum busType
        Number totalSeats
        Object seatLayout
        Array amenities
        Array images
        Boolean isActive
        Enum maintenanceStatus
    }

    TRIP {
        ObjectId _id PK
        ObjectId operatorId FK
        ObjectId routeId FK
        ObjectId busId FK
        String tripCode UK
        DateTime departureTime
        DateTime arrivalTime
        Number basePrice
        Number availableSeats
        Array occupiedSeats
        Array lockedSeats
        ObjectId driver FK
        ObjectId tripManager FK
        Enum status
    }

    BOOKING {
        ObjectId _id PK
        String bookingCode UK
        ObjectId customerId FK
        ObjectId tripId FK
        ObjectId operatorId FK
        Array seats
        Object pickupPoint
        Object dropoffPoint
        Number subtotal
        Number discount
        Number totalAmount
        ObjectId voucherId FK
        String contactEmail
        String contactPhone
        Enum status
        DateTime createdAt
    }

    TICKET {
        ObjectId _id PK
        String ticketCode UK
        ObjectId bookingId FK
        ObjectId customerId FK
        ObjectId tripId FK
        String seatNumber
        Object passenger
        String qrCode
        String qrData
        Boolean isUsed
        DateTime usedAt
        ObjectId validatedBy FK
        Object tripDetails
    }

    PAYMENT {
        ObjectId _id PK
        String transactionId UK
        ObjectId bookingId FK
        ObjectId customerId FK
        Number amount
        Enum paymentMethod
        String gatewayTransactionId
        Enum status
        Number refundAmount
        DateTime createdAt
    }

    %% ========== RELATIONSHIPS ==========

    %% BusOperator relationships
    BUS_OPERATOR ||--o{ ROUTE : "manages"
    BUS_OPERATOR ||--o{ BUS : "owns"
    BUS_OPERATOR ||--o{ TRIP : "operates"

    %% Route & Bus relationships
    ROUTE ||--o{ TRIP : "has trips"
    BUS ||--o{ TRIP : "used in trips"

    %% User relationships
    USER ||--o{ BOOKING : "makes bookings"
    USER ||--o{ PAYMENT : "makes payments"
    USER ||--o{ TICKET : "has tickets"

    %% Trip relationships
    TRIP ||--o{ BOOKING : "has bookings"
    TRIP ||--o{ TICKET : "generates tickets"

    %% Booking relationships
    BOOKING ||--|| PAYMENT : "has payment"
    BOOKING ||--o{ TICKET : "generates tickets"

    %% Notes
    %%{ Note: seatLayout, lockedSeats, passengers are EMBEDDED in parent documents }%%
    %%{ Note: Staff and Voucher models are NOT implemented yet but referenced }%%
```

**Ghi Ch√∫ Quan Tr·ªçng:**

**1. Embedded vs Referenced:**
- ‚úÖ **Referenced (FK):** `operatorId`, `routeId`, `busId`, `customerId`, `tripId`, `bookingId`
- üì¶ **Embedded:** `savedPassengers`, `address`, `bankAccount`, `origin`, `destination`, `pickupPoints`, `dropoffPoints`, `seatLayout`, `occupiedSeats`, `lockedSeats`, `seats`, `passenger`, `tripDetails`

**2. Missing Collections (Referenced but NOT Implemented):**
- üî¥ `STAFF` - Referenced in `Trip.driver` and `Trip.tripManager`
- üî¥ `VOUCHER` - Referenced in `Booking.voucherId`

**3. Indexes trong MongoDB:**
- All `_id` fields have automatic index
- Unique indexes: `email`, `phone`, `companyName`, `busNumber`, `routeCode`, `tripCode`, `bookingCode`, `ticketCode`, `transactionId`
- Compound indexes: `(operatorId, departureTime)`, `(routeId, departureTime)`, `('origin.city', 'destination.city')`

### 4.6 Technology Stack Chi Ti·∫øt

#### **Frontend**
- **Framework:** React 18.x
- **Build Tool:** Vite 5.x
- **UI Library:** Tailwind CSS 4.x + Ant Design / Material-UI
- **State Management:** Redux Toolkit / Zustand
- **HTTP Client:** Axios
- **QR Scanner:** html5-qrcode
- **PDF Viewer:** react-pdf
- **Form Handling:** React Hook Form + Yup validation
- **Date Picker:** Day.js
- **Charts:** Recharts / Chart.js
- **Maps:** Google Maps API (optional)

#### **Backend**
- **Runtime:** Node.js 20.x LTS
- **Framework:** Express.js 4.x
- **Language:** JavaScript (ES6+) / TypeScript (optional)
- **Authentication:** JWT (jsonwebtoken) + Passport.js
- **Validation:** Joi / Yup
- **ORM:** Mongoose (for MongoDB)
- **Queue:** Bull / BullMQ (Redis-based)
- **File Upload:** Multer + AWS SDK
- **QR Code:** qrcode / qr-image
- **PDF Generation:** PDFKit / Puppeteer
- **Email:** Nodemailer + SendGrid
- **SMS:** REST API calls to VNPT/Viettel
- **Payment:** SDK/API integration (VNPay, MoMo, ZaloPay)
- **Logging:** Winston / Pino
- **Testing:** Jest + Supertest

#### **Database & Cache**
- **Primary DB:** MongoDB 6.x (Replica Set)
- **Cache:** Redis 7.x (Master-Replica)
- **Session Store:** Redis
- **Full-text Search:** MongoDB Text Search / Elasticsearch (optional)

#### **DevOps & Infrastructure**
- **Containerization:** Docker + Docker Compose
- **Orchestration:** Kubernetes (optional) / Docker Swarm
- **Web Server:** Nginx
- **CI/CD:** GitHub Actions / GitLab CI
- **Cloud Provider:** AWS / Azure / GCP
- **CDN:** CloudFlare
- **Monitoring:** Prometheus + Grafana / DataDog
- **Logging:** ELK Stack (Elasticsearch, Logstash, Kibana)
- **APM:** New Relic / AppDynamics (optional)

#### **Security**
- **HTTPS/TLS:** Let's Encrypt SSL
- **Password Hashing:** bcrypt (cost factor 12)
- **Rate Limiting:** express-rate-limit + Redis
- **CORS:** cors middleware
- **Helmet:** helmet.js (security headers)
- **XSS Protection:** xss-clean
- **SQL Injection:** N/A (NoSQL, use parameterized queries)
- **CSRF:** csurf (for forms)

### 4.7 API Design Principles

#### **RESTful API Conventions**

**Base URL:** `https://api.quickride.vn/v1`

**Authentication:**
```
Authorization: Bearer <JWT_TOKEN>
```

**Response Format:**
```json
{
  "success": true,
  "data": { ... },
  "message": "Operation successful",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

**Error Format:**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_VOUCHER",
    "message": "Voucher kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
    "details": { ... }
  },
  "timestamp": "2025-01-15T10:30:00Z"
}
```

**HTTP Status Codes:**
- `200 OK` - Th√†nh c√¥ng
- `201 Created` - T·∫°o resource th√†nh c√¥ng
- `400 Bad Request` - Request kh√¥ng h·ª£p l·ªá
- `401 Unauthorized` - Ch∆∞a x√°c th·ª±c
- `403 Forbidden` - Kh√¥ng c√≥ quy·ªÅn
- `404 Not Found` - Kh√¥ng t√¨m th·∫•y
- `409 Conflict` - Xung ƒë·ªôt (vd: email ƒë√£ t·ªìn t·∫°i)
- `422 Unprocessable Entity` - Validation error
- `500 Internal Server Error` - L·ªói server

**C√°c Endpoint Ch√≠nh:**

**Auth:**
- `POST /auth/register` - ƒêƒÉng k√Ω
- `POST /auth/login` - ƒêƒÉng nh·∫≠p
- `POST /auth/logout` - ƒêƒÉng xu·∫•t
- `POST /auth/refresh-token` - L√†m m·ªõi token
- `POST /auth/forgot-password` - Qu√™n m·∫≠t kh·∫©u
- `POST /auth/verify-otp` - X√°c th·ª±c OTP

**Trips:**
- `GET /trips/search` - T√¨m ki·∫øm chuy·∫øn
- `GET /trips/:tripId` - Chi ti·∫øt chuy·∫øn
- `GET /trips/:tripId/seats` - S∆° ƒë·ªì gh·∫ø

**Bookings:**
- `POST /bookings` - T·∫°o booking
- `GET /bookings/:bookingId` - Chi ti·∫øt booking
- `PUT /bookings/:bookingId/cancel` - H·ªßy v√©
- `PUT /bookings/:bookingId/change` - ƒê·ªïi v√©
- `GET /bookings/my-bookings` - Danh s√°ch v√© c·ªßa user

**Payments:**
- `POST /payments/initiate` - Kh·ªüi t·∫°o thanh to√°n
- `POST /payments/callback` - Callback t·ª´ gateway
- `GET /payments/:paymentId` - Tr·∫°ng th√°i thanh to√°n

**Tickets:**
- `GET /tickets/:ticketId` - Chi ti·∫øt v√©
- `POST /tickets/verify` - X√°c th·ª±c v√© (qu√©t QR)
- `GET /tickets/:ticketId/download` - T·∫£i PDF

**Operators (Nh√† xe):**
- `GET /operators/routes` - Danh s√°ch tuy·∫øn
- `POST /operators/routes` - T·∫°o tuy·∫øn
- `GET /operators/buses` - Danh s√°ch xe
- `POST /operators/buses` - Th√™m xe
- `POST /operators/trips` - T·∫°o l·ªãch tr√¨nh
- `GET /operators/reports/revenue` - B√°o c√°o doanh thu

**Admin:**
- `GET /admin/users` - Qu·∫£n l√Ω users
- `GET /admin/operators/pending` - Duy·ªát nh√† xe
- `PUT /admin/operators/:id/approve` - Ph√™ duy·ªát
- `GET /admin/reports/system` - B√°o c√°o h·ªá th·ªëng

### 4.8 Chi·∫øn L∆∞·ª£c Scaling & Performance

#### **Horizontal Scaling**
- Auto-scaling cho App Servers d·ª±a tr√™n CPU/Memory usage
- Load balancing v·ªõi Nginx (Round Robin / Least Connections)
- Stateless API design ƒë·ªÉ d·ªÖ scale

#### **Database Optimization**
- MongoDB Replica Set (1 Primary + 2 Secondary)
- Indexes on: userId, tripId, bookingId, email, phoneNumber
- Sharding theo operatorId cho d·ªØ li·ªáu l·ªõn (future)

#### **Caching Strategy**
- Redis cache cho:
  - Session data (TTL: 30 ph√∫t)
  - Seat locks (TTL: 15 ph√∫t)
  - Trip search results (TTL: 5 ph√∫t)
  - Rate limiting counters
- CDN cache cho static assets (images, CSS, JS)

#### **Queue Management**
- Async processing cho:
  - Email sending
  - SMS sending
  - Report generation
  - PDF ticket generation
- Queue prioritization: Critical > Normal > Low

#### **Performance Targets**
- **API Response Time:** < 200ms (p95)
- **Database Query:** < 100ms (p95)
- **Page Load:** < 2 seconds (First Contentful Paint)
- **Concurrent Users:** 5,000+
- **Throughput:** 1,000 requests/second

---

## K·∫æT LU·∫¨N

T√†i li·ªáu n√†y cung c·∫•p c√°i nh√¨n t·ªïng quan v√† chi ti·∫øt v·ªÅ:
1. **28 Use Cases** ƒë∆∞·ª£c ƒë·∫∑c t·∫£ ng·∫Øn g·ªçn v·ªõi lu·ªìng ch√≠nh v√† thay th·∫ø
2. **24 l·ªõp ch√≠nh** v·ªõi thu·ªôc t√≠nh v√† ph∆∞∆°ng th·ª©c ƒë∆∞·ª£c x√°c ƒë·ªãnh r√µ r√†ng
3. **C√°c s∆° ƒë·ªì UML:** Class Diagram, Sequence Diagrams, Activity Diagrams, State Diagrams
4. **Ki·∫øn tr√∫c h·ªá th·ªëng:** 3-tier architecture v·ªõi microservices, deployment diagram, component diagram
5. **Technology stack** v√† API design principles

T√†i li·ªáu n√†y ƒë·ªìng b·ªô v·ªõi **Tai_lieu_xay_dung_ung_dung.txt** v√† b·ªï sung c√°c th√¥ng tin thi·∫øt k·∫ø c·∫ßn thi·∫øt ƒë·ªÉ tri·ªÉn khai h·ªá th·ªëng.

---

**Phi√™n b·∫£n:** 1.0
**Ng√†y c·∫≠p nh·∫≠t:** 2025-01-15
**Ng∆∞·ªùi so·∫°n:** System Analyst Team
