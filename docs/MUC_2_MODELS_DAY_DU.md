# M·ª§C 2: X√ÅC ƒê·ªäNH L·ªöP V√Ä QUAN H·ªÜ (MONGODB MODELS)

---

## 2. X√ÅC ƒê·ªäNH L·ªöP V√Ä QUAN H·ªÜ

### 2.1 Danh S√°ch C√°c MongoDB Models (ƒê√£ Implement)

#### **2.1.1 Nh√≥m L·ªõp Ng∆∞·ªùi D√πng (User Domain)**

**1. User Model** ‚úÖ _ƒê√£ implement: `backend/src/models/User.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK - auto generated by MongoDB)
  - email: String (required, unique, lowercase)
  - phone: String (required, unique)
  - password: String (required, minlength: 8, hashed with bcrypt, select: false)
  - fullName: String (required)
  - dateOfBirth: Date (optional)
  - gender: Enum ('male', 'female', 'other')
  - avatar: String (URL)
  - role: Enum ('customer', 'admin') - default: 'customer'

  - **OAuth:**
    - googleId: String
    - facebookId: String

  - **Verification:**
    - isEmailVerified: Boolean (default: false)
    - isPhoneVerified: Boolean (default: false)
    - emailVerificationToken: String
    - phoneVerificationOTP: String
    - otpExpires: Date

  - **Security:**
    - passwordResetToken: String
    - passwordResetExpires: Date
    - lastLogin: Date

  - **Preferences:**
    - savedPassengers: Array of embedded documents
      - fullName: String
      - phone: String
      - idCard: String

  - **Loyalty:**
    - loyaltyTier: Enum ('bronze', 'silver', 'gold', 'platinum') - default: 'bronze'
    - totalPoints: Number (default: 0)

  - **Status:**
    - isActive: Boolean (default: true)
    - isBlocked: Boolean (default: false)

  - createdAt: DateTime (auto - timestamps)
  - updatedAt: DateTime (auto - timestamps)

- **Indexes:**
  - email: 1
  - phone: 1
  - googleId: 1
  - facebookId: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Pre-save hook: Hash password v·ªõi bcrypt (salt rounds: 12)
  - comparePassword(candidatePassword): Promise<Boolean>
  - toJSON(): Object (·∫©n c√°c field nh·∫°y c·∫£m)

- **Ghi ch√∫:**
  - Trong thi·∫øt k·∫ø ban ƒë·∫ßu c√≥ t√°ch Customer v√† Guest, nh∆∞ng trong code hi·ªán t·∫°i User model x·ª≠ l√Ω c·∫£ hai roles th√¥ng qua field `role` v√† logic x√°c th·ª±c

**2. BusOperator Model** ‚úÖ _ƒê√£ implement: `backend/src/models/BusOperator.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - companyName: String (required, unique)
  - email: String (required, unique, lowercase)
  - phone: String (required)
  - password: String (required, minlength: 8, hashed, select: false)

  - **Business Info:**
    - businessLicense: String (required)
    - taxCode: String (required)
    - logo: String (URL)
    - description: String
    - website: String

  - **Address (embedded object):**
    - street: String
    - ward: String
    - district: String
    - city: String
    - country: String (default: 'Vietnam')

  - **Bank Info (embedded object):**
    - bankName: String
    - accountNumber: String
    - accountHolder: String

  - **Approval:**
    - verificationStatus: Enum ('pending', 'approved', 'rejected') - default: 'pending'
    - verifiedAt: Date
    - verifiedBy: ObjectId (ref: 'User')
    - rejectionReason: String

  - **Rating:**
    - averageRating: Number (default: 0, min: 0, max: 5)
    - totalReviews: Number (default: 0)

  - **Statistics:**
    - totalTrips: Number (default: 0)
    - totalRevenue: Number (default: 0)

  - **Commission:**
    - commissionRate: Number (default: 5, min: 0, max: 100) // Percentage

  - **Status:**
    - isActive: Boolean (default: true)
    - isSuspended: Boolean (default: false)
    - suspensionReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - companyName: 1
  - email: 1
  - verificationStatus: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Pre-save hook: Hash password v·ªõi bcrypt (salt rounds: 12)
  - comparePassword(candidatePassword): Promise<Boolean>
  - toJSON(): Object (·∫©n password)

#### **2.1.2 Nh√≥m L·ªõp Tuy·∫øn ƒê∆∞·ªùng v√† L·ªãch Tr√¨nh (Route & Schedule Domain)**

**3. Route Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Route.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - routeName: String (required)
  - routeCode: String (required, unique, uppercase)

  - **Origin (embedded locationSchema):**
    - city: String (required)
    - province: String (required)
    - station: String
    - address: String
    - coordinates: { lat: Number, lng: Number }

  - **Destination (embedded locationSchema):**
    - city: String (required)
    - province: String (required)
    - station: String
    - address: String
    - coordinates: { lat: Number, lng: Number }

  - **Pickup & Dropoff Points (embedded pointSchema):**
    - pickupPoints: Array of { name: String, address: String, coordinates: {lat, lng} }
    - dropoffPoints: Array of { name: String, address: String, coordinates: {lat, lng} }

  - **Route Details:**
    - distance: Number (required, min: 0) // km
    - estimatedDuration: Number (required, min: 0) // minutes

  - **Status:**
    - isActive: Boolean (default: true)

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - routeCode: 1
  - operatorId: 1
  - 'origin.city': 1, 'destination.city': 1

- **Ghi ch√∫:**
  - Location v√† Point ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded schema, kh√¥ng ph·∫£i separate collection

**4. Bus Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Bus.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - busNumber: String (required, unique, uppercase) // License plate
  - busType: Enum ('limousine', 'sleeper', 'seater', 'double_decker') - required

  - **Seat Configuration (embedded seatLayout):**
    - seatLayout.floors: Number (required, min: 1, max: 2)
    - seatLayout.rows: Number (required)
    - seatLayout.columns: Number (required)
    - seatLayout.layout: Array of Array of String (required) // 2D array representing seat map

  - totalSeats: Number (required, min: 1)

  - **Amenities:**
    - amenities: Array of Enum ('wifi', 'ac', 'toilet', 'water', 'blanket', 'tv', 'usb_charger', 'reading_light')

  - **Images:**
    - images: Array of String (URLs)

  - **Status:**
    - isActive: Boolean (default: true)
    - maintenanceStatus: Enum ('good', 'maintenance', 'repair') - default: 'good'

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - operatorId: 1
  - busNumber: 1

- **Ghi ch√∫:**
  - SeatLayout ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded object, kh√¥ng ph·∫£i separate collection
  - Seat configuration ƒë∆∞·ª£c l∆∞u tr·ªØ d∆∞·ªõi d·∫°ng 2D array trong field layout

**5. Trip Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Trip.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - routeId: ObjectId (ref: 'Route', required)
  - busId: ObjectId (ref: 'Bus', required)
  - tripCode: String (required, unique, uppercase)

  - **Schedule:**
    - departureTime: Date (required)
    - arrivalTime: Date (required)

  - **Pricing:**
    - basePrice: Number (required, min: 0)

  - **Seat Availability:**
    - availableSeats: Number (required)
    - occupiedSeats: Array of String // Seat numbers
    - lockedSeats: Array of embedded objects
      - seatNumber: String
      - lockedUntil: Date
      - sessionId: String

  - **Staff Assignment:**
    - driver: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_
    - tripManager: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - **Status:**
    - status: Enum ('scheduled', 'boarding', 'in_progress', 'completed', 'cancelled') - default: 'scheduled'
    - cancellationReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - tripCode: 1
  - operatorId: 1, departureTime: 1
  - routeId: 1, departureTime: 1
  - departureTime: 1, status: 1

- **Ph∆∞∆°ng th·ª©c:**
  - isSeatAvailable(seatNumber): Boolean
  - lockSeats(seatNumbers, sessionId, durationMinutes = 15): Promise
  - releaseLocks(sessionId): Promise
  - occupySeats(seatNumbers): Promise

- **Ghi ch√∫:**
  - SeatLock ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded array, kh√¥ng ph·∫£i separate collection
  - Staff model ch∆∞a ƒë∆∞·ª£c t·∫°o, c·∫ßn implement tr∆∞·ªõc khi deploy production

#### **2.1.3 Nh√≥m L·ªõp ƒê·∫∑t V√© (Booking Domain)**

**6. Booking Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Booking.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - bookingCode: String (required, unique, uppercase) // Format: BKYYYYMMDD####
  - customerId: ObjectId (ref: 'User', required)
  - tripId: ObjectId (ref: 'Trip', required)
  - operatorId: ObjectId (ref: 'BusOperator', required)

  - **Seats (array of embedded objects):**
    - seats: Array of
      - seatNumber: String (required)
      - passenger: embedded object
        - fullName: String (required)
        - phone: String (required)
        - idCard: String

  - **Pickup & Dropoff (embedded objects):**
    - pickupPoint: { name: String, address: String, coordinates: {lat, lng} }
    - dropoffPoint: { name: String, address: String, coordinates: {lat, lng} }

  - **Pricing:**
    - subtotal: Number (required, min: 0)
    - discount: Number (default: 0, min: 0)
    - totalAmount: Number (required, min: 0)

  - **Voucher:**
    - voucherId: ObjectId (ref: 'Voucher') ‚ö†Ô∏è _Voucher model ch∆∞a t·∫°o_
    - voucherCode: String

  - **Contact:**
    - contactEmail: String (required)
    - contactPhone: String (required)
    - notes: String

  - **Status:**
    - status: Enum ('pending', 'confirmed', 'cancelled', 'completed') - default: 'pending'

  - **Cancellation:**
    - cancellationReason: String
    - cancelledAt: Date
    - refundAmount: Number (default: 0)
    - refundStatus: Enum ('pending', 'processed', 'failed')

  - **Check-in:**
    - checkedInSeats: Array of String
    - checkedInAt: Date
    - checkedInBy: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - bookingCode: 1
  - customerId: 1
  - tripId: 1
  - status: 1
  - createdAt: -1

- **Static Methods:**
  - generateBookingCode(): Promise<String> // Generates unique booking code

- **Ghi ch√∫:**
  - Passenger ƒë∆∞·ª£c implement d∆∞·ªõi d·∫°ng embedded object trong seats array, kh√¥ng ph·∫£i separate collection
  - Voucher model ch∆∞a ƒë∆∞·ª£c t·∫°o

**7. Ticket Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Ticket.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - ticketCode: String (required, unique, uppercase) // Format: TKYYYYMMDD####
  - bookingId: ObjectId (ref: 'Booking', required)
  - customerId: ObjectId (ref: 'User', required)
  - tripId: ObjectId (ref: 'Trip', required)

  - **Seat & Passenger Info (embedded):**
    - seatNumber: String (required)
    - passenger: embedded object
      - fullName: String (required)
      - phone: String (required)
      - idCard: String

  - **QR Code:**
    - qrCode: String (required) // Base64 image
    - qrData: String (required) // Encrypted data for verification

  - **Ticket PDF:**
    - ticketPDF: String // URL to PDF file

  - **Validation:**
    - isValid: Boolean (default: true)
    - isUsed: Boolean (default: false)
    - usedAt: Date
    - validatedBy: ObjectId (ref: 'Staff') ‚ö†Ô∏è _Staff model ch∆∞a t·∫°o_

  - **Trip Details (denormalized for quick access):**
    - tripDetails: embedded object
      - routeName: String
      - origin: String
      - destination: String
      - departureTime: Date
      - busNumber: String
      - operatorName: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - ticketCode: 1
  - bookingId: 1
  - qrData: 1
  - customerId: 1

- **Static Methods:**
  - generateTicketCode(): Promise<String>

- **Ghi ch√∫:**
  - Trip details ƒë∆∞·ª£c denormalize ƒë·ªÉ tr√°nh join khi hi·ªÉn th·ªã v√©
  - QR code data ƒë∆∞·ª£c m√£ h√≥a ƒë·ªÉ b·∫£o m·∫≠t

#### **2.1.4 Nh√≥m L·ªõp Thanh To√°n (Payment Domain)**

**8. Payment Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Payment.js`_
- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - transactionId: String (required, unique) // Format: TXN{timestamp}{random}
  - bookingId: ObjectId (ref: 'Booking', required)
  - customerId: ObjectId (ref: 'User', required)

  - **Amount:**
    - amount: Number (required, min: 0)
    - currency: String (default: 'VND')

  - **Payment Method:**
    - paymentMethod: Enum ('momo', 'vnpay', 'zalopay', 'shopeepay', 'atm', 'visa', 'mastercard', 'cod') - required

  - **Gateway Info:**
    - gatewayTransactionId: String
    - gatewayResponse: Mixed (object ch·ª©a response t·ª´ payment gateway)

  - **Status:**
    - status: Enum ('pending', 'success', 'failed', 'refunded') - default: 'pending'

  - **Refund:**
    - refundAmount: Number (default: 0)
    - refundedAt: Date
    - refundReason: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - transactionId: 1
  - bookingId: 1
  - customerId: 1
  - status: 1
  - createdAt: -1

- **Static Methods:**
  - generateTransactionId(): Promise<String>

---

### 2.2 Danh S√°ch C√°c Models ƒê√£ Implement ƒê·∫ßy ƒê·ªß (B·ªï Sung)

> **‚úÖ L∆∞u √Ω:** C√°c models d∆∞·ªõi ƒë√¢y ƒë√£ ƒë∆∞·ª£c implement ƒë·∫ßy ƒë·ªß v·ªõi thu·ªôc t√≠nh, indexes v√† ph∆∞∆°ng th·ª©c.

#### **Models ∆Øu Ti√™n Cao (Critical)**

**9. Staff Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Staff.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK - auto generated by MongoDB)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - employeeCode: String (required, unique, uppercase)
  - fullName: String (required)
  - phone: String (required)
  - email: String (lowercase)
  - dateOfBirth: Date
  - avatar: String (URL)
  - address: String

  - **Role & Status:**
    - role: Enum ('driver', 'tripManager', 'ticketChecker') - required
    - status: Enum ('active', 'onLeave', 'resigned') - default: 'active'

  - **Authentication:**
    - password: String (required, minlength: 8, hashed with bcrypt, select: false)
    - lastLogin: Date

  - **Driver Specific:**
    - licenseNumber: String // Gi·∫•y ph√©p l√°i xe
    - licenseExpiry: Date
    - experienceYears: Number (min: 0)

  - **Statistics:**
    - totalTripsCompleted: Number (default: 0)
    - averageRating: Number (default: 0, min: 0, max: 5)
    - totalRatings: Number (default: 0)

  - createdAt: DateTime (auto - timestamps)
  - updatedAt: DateTime (auto - timestamps)

- **Indexes:**
  - employeeCode: 1
  - operatorId: 1, status: 1
  - role: 1
  - email: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Pre-save hook: Hash password v·ªõi bcrypt (salt rounds: 12)
  - comparePassword(candidatePassword): Promise<Boolean>
  - toJSON(): Object (·∫©n password v√† c√°c field nh·∫°y c·∫£m)
  - Instance method: isAvailable(date): Promise<Boolean> - Ki·ªÉm tra staff c√≥ r·∫£nh v√†o ng√†y c·ª• th·ªÉ
  - Static method: findAvailableStaff(operatorId, role, date): Promise<Array> - T√¨m nh√¢n vi√™n r·∫£nh

- **Ghi ch√∫:**
  - Model n√†y ƒë∆∞·ª£c reference b·ªüi Trip (driver, tripManager), Booking (checkedInBy), v√† Ticket (validatedBy)
  - C·∫ßn validate licenseExpiry cho role 'driver'

---

**10. Voucher Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Voucher.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - code: String (required, unique, uppercase, minlength: 4, maxlength: 20)
  - title: String (required) // T√™n voucher hi·ªÉn th·ªã
  - description: String

  - **Discount Configuration:**
    - discountType: Enum ('percentage', 'fixed') - required
    - discountValue: Number (required, min: 0)
    - maxDiscount: Number (min: 0) // Gi·∫£m t·ªëi ƒëa (cho percentage)
    - minOrderValue: Number (default: 0, min: 0) // Gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu

  - **Validity:**
    - validFrom: Date (required)
    - validTo: Date (required)

  - **Usage Limits:**
    - usageLimit: Number (min: 1) // null = unlimited
    - usedCount: Number (default: 0, min: 0)
    - usageLimitPerUser: Number (default: 1, min: 1)

  - **Scope:**
    - operatorId: ObjectId (ref: 'BusOperator') // null = system-wide voucher
    - applicableRoutes: Array of ObjectId (ref: 'Route') // √Åp d·ª•ng cho tuy·∫øn c·ª• th·ªÉ
    - applicableBusTypes: Array of Enum ('limousine', 'sleeper', 'seater', 'double_decker')

  - **Status:**
    - isActive: Boolean (default: true)
    - isPublic: Boolean (default: true) // false = voucher ri√™ng t∆∞ (qua email)

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - code: 1
  - operatorId: 1, isActive: 1
  - validFrom: 1, validTo: 1
  - isActive: 1, validFrom: 1, validTo: 1

- **Ph∆∞∆°ng th·ª©c:**
  - Instance method: isValid(currentDate = new Date()): Boolean - Ki·ªÉm tra voucher c√≤n hi·ªáu l·ª±c
  - Instance method: canBeUsed(userId, orderValue, routeId, busType): Promise<Boolean> - Ki·ªÉm tra c√≥ th·ªÉ s·ª≠ d·ª•ng
  - Instance method: calculateDiscount(orderValue): Number - T√≠nh s·ªë ti·ªÅn gi·∫£m
  - Instance method: incrementUsage(): Promise - TƒÉng s·ªë l·∫ßn s·ª≠ d·ª•ng
  - Static method: findValidVouchers(operatorId, routeId, busType): Promise<Array> - T√¨m voucher kh·∫£ d·ª•ng
  - Pre-save hook: Validate validTo > validFrom

- **Ghi ch√∫:**
  - ƒê∆∞·ª£c reference b·ªüi Booking model
  - C·∫ßn track usage per user trong separate collection n·∫øu c·∫ßn chi ti·∫øt

---

#### **Models ∆Øu Ti√™n Trung B√¨nh (Nice to Have)**

**11. Review Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Review.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - bookingId: ObjectId (ref: 'Booking', required, unique) // M·ªôt booking ch·ªâ c√≥ 1 review
  - customerId: ObjectId (ref: 'User', required)
  - operatorId: ObjectId (ref: 'BusOperator', required)
  - tripId: ObjectId (ref: 'Trip')

  - **Ratings:**
    - overallRating: Number (required, min: 1, max: 5)
    - busRating: Number (min: 1, max: 5)
    - driverRating: Number (min: 1, max: 5)
    - punctualityRating: Number (min: 1, max: 5)
    - serviceRating: Number (min: 1, max: 5)

  - **Review Content:**
    - comment: String (maxlength: 1000)
    - images: Array of String (URLs) // ·∫¢nh ƒë√°nh gi√°

  - **Status:**
    - isApproved: Boolean (default: false) // Admin duy·ªát
    - isHidden: Boolean (default: false)
    - approvedBy: ObjectId (ref: 'User')
    - approvedAt: Date

  - **Response:**
    - operatorResponse: String // Ph·∫£n h·ªìi t·ª´ nh√† xe
    - respondedAt: Date

  - **Helpful:**
    - helpfulCount: Number (default: 0) // S·ªë ng∆∞·ªùi th·∫•y h·ªØu √≠ch

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - bookingId: 1
  - customerId: 1
  - operatorId: 1, isApproved: 1
  - tripId: 1
  - overallRating: 1
  - createdAt: -1

- **Ph∆∞∆°ng th·ª©c:**
  - Instance method: approve(adminId): Promise - Duy·ªát ƒë√°nh gi√°
  - Instance method: hide(): Promise - ·∫®n ƒë√°nh gi√°
  - Instance method: addOperatorResponse(response): Promise - Th√™m ph·∫£n h·ªìi t·ª´ nh√† xe
  - Static method: getAverageRatings(operatorId): Promise<Object> - T√≠nh rating trung b√¨nh
  - Post-save hook: C·∫≠p nh·∫≠t averageRating v√† totalReviews c·ªßa BusOperator

- **Ghi ch√∫:**
  - Ch·ªâ cho ph√©p review sau khi chuy·∫øn xe completed
  - C·∫ßn validate booking ƒë√£ ho√†n th√†nh tr∆∞·ªõc khi t·∫°o review

---

**12. Notification Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Notification.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - userId: ObjectId (ref: 'User', required)

  - **Notification Type:**
    - type: Enum ('email', 'sms', 'push', 'in_app') - required
    - category: Enum ('booking', 'payment', 'promotion', 'system', 'reminder') - required

  - **Content:**
    - title: String (required, maxlength: 200)
    - content: String (required, maxlength: 2000)
    - imageUrl: String
    - actionUrl: String // Deep link ho·∫∑c URL

  - **Delivery:**
    - status: Enum ('pending', 'sent', 'failed', 'read') - default: 'pending'
    - sentAt: Date
    - readAt: Date
    - failureReason: String

  - **Priority:**
    - priority: Enum ('low', 'normal', 'high', 'urgent') - default: 'normal'

  - **Metadata:**
    - metadata: Mixed // Object ch·ª©a th√¥ng tin b·ªï sung (bookingId, tripId, etc.)

  - **Scheduling:**
    - scheduledFor: Date // G·ª≠i v√†o th·ªùi ƒëi·ªÉm c·ª• th·ªÉ
    - expiresAt: Date

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - userId: 1, status: 1
  - userId: 1, readAt: 1
  - type: 1, status: 1
  - scheduledFor: 1, status: 1
  - createdAt: -1

- **Ph∆∞∆°ng th·ª©c:**
  - Instance method: markAsSent(): Promise - ƒê√°nh d·∫•u ƒë√£ g·ª≠i
  - Instance method: markAsRead(): Promise - ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
  - Instance method: markAsFailed(reason): Promise - ƒê√°nh d·∫•u th·∫•t b·∫°i
  - Static method: createBookingNotification(userId, bookingId, type): Promise<Notification>
  - Static method: getPendingNotifications(limit = 100): Promise<Array> - L·∫•y notifications ch∆∞a g·ª≠i
  - Static method: getUnreadCount(userId): Promise<Number> - ƒê·∫øm th√¥ng b√°o ch∆∞a ƒë·ªçc
  - Static method: markAllAsRead(userId): Promise - ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc

- **Ghi ch√∫:**
  - L√†m vi·ªác v·ªõi notificationService.js ƒë·ªÉ g·ª≠i th√¥ng b√°o
  - C√≥ th·ªÉ d√πng cron job ƒë·ªÉ g·ª≠i scheduled notifications

---

**13. Content Model** ‚úÖ _ƒê√£ implement: `backend/src/models/Content.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)

  - **Content Type:**
    - type: Enum ('banner', 'blog', 'faq', 'policy', 'announcement', 'promotion') - required
    - slug: String (required, unique, lowercase) // URL-friendly

  - **Content:**
    - title: String (required, maxlength: 200)
    - subtitle: String (maxlength: 300)
    - body: String (required) // HTML ho·∫∑c Markdown
    - excerpt: String (maxlength: 500) // M√¥ t·∫£ ng·∫Øn
    - imageUrl: String
    - thumbnailUrl: String
    - tags: Array of String

  - **SEO:**
    - metaTitle: String
    - metaDescription: String
    - metaKeywords: Array of String

  - **Display:**
    - isActive: Boolean (default: true)
    - order: Number (default: 0) // Th·ª© t·ª± hi·ªÉn th·ªã
    - featured: Boolean (default: false) // N·ªïi b·∫≠t

  - **Author:**
    - createdBy: ObjectId (ref: 'User', required)
    - updatedBy: ObjectId (ref: 'User')

  - **Analytics:**
    - viewCount: Number (default: 0)
    - likeCount: Number (default: 0)

  - **Scheduling:**
    - publishedAt: Date
    - expiresAt: Date

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - slug: 1
  - type: 1, isActive: 1
  - type: 1, order: 1
  - featured: 1, isActive: 1
  - createdBy: 1
  - publishedAt: -1

- **Ph∆∞∆°ng th·ª©c:**
  - Instance method: incrementView(): Promise - TƒÉng l∆∞·ª£t xem
  - Instance method: incrementLike(): Promise - TƒÉng l∆∞·ª£t th√≠ch
  - Instance method: publish(): Promise - Xu·∫•t b·∫£n content
  - Instance method: unpublish(): Promise - G·ª° xu·∫•t b·∫£n
  - Static method: getFeaturedContent(type, limit = 5): Promise<Array> - L·∫•y content n·ªïi b·∫≠t
  - Static method: getContentByType(type, options): Promise<Array> - L·∫•y theo lo·∫°i
  - Pre-save hook: Generate slug t·ª´ title n·∫øu ch∆∞a c√≥
  - Pre-save hook: Set publishedAt n·∫øu chuy·ªÉn isActive t·ª´ false -> true

- **Ghi ch√∫:**
  - D√πng cho CMS (Content Management System)
  - Body c√≥ th·ªÉ ch·ª©a HTML ho·∫∑c Markdown t√πy implementation

---

**14. SupportTicket Model** ‚úÖ _ƒê√£ implement: `backend/src/models/SupportTicket.js`_

- **Thu·ªôc t√≠nh:**
  - _id: ObjectId (PK)
  - ticketNumber: String (required, unique, uppercase) // Format: TK{YYYYMMDD}{####}
  - userId: ObjectId (ref: 'User', required)

  - **Ticket Info:**
    - subject: String (required, maxlength: 200)
    - description: String (required, maxlength: 2000)
    - category: Enum ('booking', 'payment', 'refund', 'technical', 'complaint', 'other') - required
    - relatedBookingId: ObjectId (ref: 'Booking')
    - relatedPaymentId: ObjectId (ref: 'Payment')

  - **Priority & Status:**
    - priority: Enum ('low', 'medium', 'high', 'urgent') - default: 'medium'
    - status: Enum ('open', 'assigned', 'inProgress', 'resolved', 'closed', 'cancelled') - default: 'open'

  - **Assignment:**
    - assignedTo: ObjectId (ref: 'User') // Admin/Support user
    - assignedAt: Date

  - **Messages (embedded array):**
    - messages: Array of embedded objects
      - sender: ObjectId (ref: 'User', required)
      - senderType: Enum ('customer', 'admin')
      - message: String (required)
      - attachments: Array of String (URLs)
      - createdAt: Date (default: Date.now)

  - **Resolution:**
    - resolutionNote: String
    - resolvedAt: Date
    - resolvedBy: ObjectId (ref: 'User')
    - closedAt: Date

  - **Rating:**
    - satisfactionRating: Number (min: 1, max: 5) // ƒê√°nh gi√° sau khi gi·∫£i quy·∫øt
    - feedbackComment: String

  - createdAt: DateTime (auto)
  - updatedAt: DateTime (auto)

- **Indexes:**
  - ticketNumber: 1
  - userId: 1, status: 1
  - assignedTo: 1, status: 1
  - category: 1, status: 1
  - status: 1, priority: 1
  - createdAt: -1

- **Ph∆∞∆°ng th·ª©c:**
  - Static method: generateTicketNumber(): Promise<String> - T·∫°o m√£ ticket
  - Instance method: addMessage(senderId, senderType, message, attachments): Promise - Th√™m tin nh·∫Øn
  - Instance method: assignTo(adminId): Promise - G√°n cho admin
  - Instance method: updateStatus(newStatus): Promise - C·∫≠p nh·∫≠t tr·∫°ng th√°i
  - Instance method: resolve(adminId, note): Promise - ƒê√°nh d·∫•u ƒë√£ gi·∫£i quy·∫øt
  - Instance method: close(): Promise - ƒê√≥ng ticket
  - Instance method: addRating(rating, comment): Promise - Th√™m ƒë√°nh gi√°
  - Static method: getTicketsByStatus(status, options): Promise<Array>
  - Static method: getMyTickets(userId, options): Promise<Array>
  - Static method: getAssignedTickets(adminId, options): Promise<Array>
  - Pre-save hook: T·ª± ƒë·ªông set assignedAt khi c√≥ assignedTo
  - Post-save hook: G·ª≠i notification khi c√≥ message m·ªõi

- **Ghi ch√∫:**
  - Messages ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng embedded array
  - C·∫ßn real-time updates cho chat (c√≥ th·ªÉ d√πng Socket.io)

---

### 2.3 T√≥m T·∫Øt Tr·∫°ng Th√°i Implementation

| # | Model | Status | File Path | Priority |
|---|-------|--------|-----------|----------|
| 1 | User | ‚úÖ Implemented | `backend/src/models/User.js` | - |
| 2 | BusOperator | ‚úÖ Implemented | `backend/src/models/BusOperator.js` | - |
| 3 | Route | ‚úÖ Implemented | `backend/src/models/Route.js` | - |
| 4 | Bus | ‚úÖ Implemented | `backend/src/models/Bus.js` | - |
| 5 | Trip | ‚úÖ Implemented | `backend/src/models/Trip.js` | - |
| 6 | Booking | ‚úÖ Implemented | `backend/src/models/Booking.js` | - |
| 7 | Ticket | ‚úÖ Implemented | `backend/src/models/Ticket.js` | - |
| 8 | Payment | ‚úÖ Implemented | `backend/src/models/Payment.js` | - |
| 9 | **Staff** | ‚úÖ **Implemented** | `backend/src/models/Staff.js` | **CRITICAL** |
| 10 | **Voucher** | ‚úÖ **Implemented** | `backend/src/models/Voucher.js` | **IMPORTANT** |
| 11 | Review | ‚úÖ Implemented | `backend/src/models/Review.js` | Nice to Have |
| 12 | Notification | ‚úÖ Implemented | `backend/src/models/Notification.js` | Nice to Have |
| 13 | Content | ‚úÖ Implemented | `backend/src/models/Content.js` | Nice to Have |
| 14 | SupportTicket | ‚úÖ Implemented | `backend/src/models/SupportTicket.js` | Nice to Have |

---

### 2.4 Class Diagram (S∆° ƒê·ªì L·ªõp - MongoDB Models Implemented)

> **Ch√∫ th√≠ch:** S∆° ƒë·ªì n√†y hi·ªÉn th·ªã t·∫•t c·∫£ c√°c models ƒë√£ ƒë∆∞·ª£c implement ƒë·∫ßy ƒë·ªß.

```mermaid
%%{init: {'theme':'dark'}}%%
classDiagram
    %% ========== IMPLEMENTED MODELS ==========

    %% User Model
    class User {
        <<MongoDB Model>>
        -ObjectId _id
        -String email*
        -String phone*
        -String password
        -String fullName*
        -Date dateOfBirth
        -Enum gender
        -String avatar
        -Enum role
        -String googleId
        -String facebookId
        -Boolean isEmailVerified
        -Boolean isPhoneVerified
        -Array savedPassengers
        -Enum loyaltyTier
        -Number totalPoints
        -Boolean isActive
        -Boolean isBlocked
        +comparePassword()
        +toJSON()
    }

    %% BusOperator Model
    class BusOperator {
        <<MongoDB Model>>
        -ObjectId _id
        -String companyName*
        -String email*
        -String phone*
        -String password
        -String businessLicense*
        -String taxCode*
        -String logo
        -Object address
        -Object bankAccount
        -Enum verificationStatus
        -Date verifiedAt
        -Number averageRating
        -Number totalReviews
        -Number totalTrips
        -Number totalRevenue
        -Number commissionRate
        -Boolean isActive
        -Boolean isSuspended
        +comparePassword()
        +toJSON()
    }

    %% Route Model
    class Route {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -String routeName*
        -String routeCode*
        -Object origin*
        -Object destination*
        -Array pickupPoints
        -Array dropoffPoints
        -Number distance*
        -Number estimatedDuration*
        -Boolean isActive
    }

    %% Bus Model
    class Bus {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -String busNumber*
        -Enum busType*
        -Number totalSeats*
        -Object seatLayout*
        -Array amenities
        -Array images
        -Boolean isActive
        -Enum maintenanceStatus
    }

    %% Trip Model
    class Trip {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -ObjectId routeId*
        -ObjectId busId*
        -String tripCode*
        -Date departureTime*
        -Date arrivalTime*
        -Number basePrice*
        -Number availableSeats*
        -Array occupiedSeats
        -Array lockedSeats
        -ObjectId driver
        -ObjectId tripManager
        -Enum status
        +isSeatAvailable()
        +lockSeats()
        +releaseLocks()
        +occupySeats()
    }

    %% Booking Model
    class Booking {
        <<MongoDB Model>>
        -ObjectId _id
        -String bookingCode*
        -ObjectId customerId*
        -ObjectId tripId*
        -ObjectId operatorId*
        -Array seats*
        -Object pickupPoint
        -Object dropoffPoint
        -Number subtotal*
        -Number discount
        -Number totalAmount*
        -ObjectId voucherId
        -String voucherCode
        -String contactEmail*
        -String contactPhone*
        -Enum status
        -Date cancelledAt
        -Number refundAmount
        -Array checkedInSeats
        +generateBookingCode()
    }

    %% Ticket Model
    class Ticket {
        <<MongoDB Model>>
        -ObjectId _id
        -String ticketCode*
        -ObjectId bookingId*
        -ObjectId customerId*
        -ObjectId tripId*
        -String seatNumber*
        -Object passenger*
        -String qrCode*
        -String qrData*
        -String ticketPDF
        -Boolean isValid
        -Boolean isUsed
        -Date usedAt
        -ObjectId validatedBy
        -Object tripDetails
        +generateTicketCode()
    }

    %% Payment Model
    class Payment {
        <<MongoDB Model>>
        -ObjectId _id
        -String transactionId*
        -ObjectId bookingId*
        -ObjectId customerId*
        -Number amount*
        -String currency
        -Enum paymentMethod*
        -String gatewayTransactionId
        -Mixed gatewayResponse
        -Enum status
        -Number refundAmount
        -Date refundedAt
        -String refundReason
        +generateTransactionId()
    }

    %% Staff Model
    class Staff {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId operatorId*
        -String employeeCode*
        -String fullName*
        -String phone*
        -String email
        -Enum role*
        -Enum status
        -String password
        -String licenseNumber
        -Date licenseExpiry
        -Number experienceYears
        -Number totalTripsCompleted
        -Number averageRating
        +comparePassword()
        +toJSON()
        +isAvailable()
        +findAvailableStaff()
    }

    %% Voucher Model
    class Voucher {
        <<MongoDB Model>>
        -ObjectId _id
        -String code*
        -String title*
        -Enum discountType*
        -Number discountValue*
        -Number maxDiscount
        -Number minOrderValue
        -Date validFrom*
        -Date validTo*
        -Number usageLimit
        -Number usedCount
        -ObjectId operatorId
        -Array applicableRoutes
        -Array applicableBusTypes
        -Boolean isActive
        -Boolean isPublic
        +isValid()
        +canBeUsed()
        +calculateDiscount()
        +incrementUsage()
        +findValidVouchers()
    }

    %% Review Model
    class Review {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId bookingId*
        -ObjectId customerId*
        -ObjectId operatorId*
        -ObjectId tripId
        -Number overallRating*
        -Number busRating
        -Number driverRating
        -Number punctualityRating
        -Number serviceRating
        -String comment
        -Array images
        -Boolean isApproved
        -String operatorResponse
        -Number helpfulCount
        +approve()
        +hide()
        +addOperatorResponse()
        +getAverageRatings()
    }

    %% Notification Model
    class Notification {
        <<MongoDB Model>>
        -ObjectId _id
        -ObjectId userId*
        -Enum type*
        -Enum category*
        -String title*
        -String content*
        -String imageUrl
        -String actionUrl
        -Enum status
        -Date sentAt
        -Date readAt
        -Enum priority
        -Mixed metadata
        -Date scheduledFor
        +markAsSent()
        +markAsRead()
        +markAsFailed()
        +createBookingNotification()
        +getPendingNotifications()
        +getUnreadCount()
    }

    %% Content Model
    class Content {
        <<MongoDB Model>>
        -ObjectId _id
        -Enum type*
        -String slug*
        -String title*
        -String subtitle
        -String body*
        -String excerpt
        -String imageUrl
        -Array tags
        -Boolean isActive
        -Number order
        -Boolean featured
        -ObjectId createdBy*
        -Number viewCount
        -Date publishedAt
        +incrementView()
        +incrementLike()
        +publish()
        +unpublish()
        +getFeaturedContent()
        +getContentByType()
    }

    %% SupportTicket Model
    class SupportTicket {
        <<MongoDB Model>>
        -ObjectId _id
        -String ticketNumber*
        -ObjectId userId*
        -String subject*
        -String description*
        -Enum category*
        -ObjectId relatedBookingId
        -Enum priority
        -Enum status
        -ObjectId assignedTo
        -Array messages
        -String resolutionNote
        -Date resolvedAt
        -Number satisfactionRating
        +generateTicketNumber()
        +addMessage()
        +assignTo()
        +updateStatus()
        +resolve()
        +close()
        +addRating()
    }

    %% ========== RELATIONSHIPS ==========

    %% User relationships
    User "1" -- "0..*" Booking : makes
    User "1" -- "0..*" Review : writes
    User "1" -- "0..*" Notification : receives
    User "1" -- "0..*" Content : creates
    User "1" -- "0..*" SupportTicket : creates

    %% BusOperator relationships
    BusOperator "1" -- "0..*" Route : manages
    BusOperator "1" -- "0..*" Bus : owns
    BusOperator "1" -- "0..*" Trip : operates
    BusOperator "1" -- "0..*" Staff : employs
    BusOperator "1" -- "0..*" Voucher : creates
    BusOperator "1" -- "0..*" Review : receives

    %% Trip relationships
    Trip "1" -- "1" Route : follows
    Trip "1" -- "1" Bus : uses
    Trip "1" -- "0..1" Staff : has driver
    Trip "1" -- "0..1" Staff : has tripManager
    Trip "1" -- "0..*" Booking : has
    Trip "1" -- "0..*" Review : receives

    %% Booking relationships
    Booking "1" -- "1" Trip : for
    Booking "1" -- "1" User : by
    Booking "1" -- "1" BusOperator : with
    Booking "1" -- "0..1" Voucher : uses
    Booking "1" -- "1..*" Ticket : generates
    Booking "1" -- "1" Payment : has
    Booking "1" -- "0..1" Review : has
    Booking "1" -- "0..*" SupportTicket : relates

    %% Payment relationships
    Payment "1" -- "1" Booking : for
    Payment "1" -- "1" User : by

    %% Ticket relationships
    Ticket "1" -- "1" Booking : from
    Ticket "1" -- "1" Trip : for
    Ticket "1" -- "0..1" Staff : validated by

    %% Staff relationships
    Staff "1" -- "0..*" Trip : operates
    Staff "1" -- "0..*" Ticket : validates

    %% Styling
    style User fill:#4a9eff
    style BusOperator fill:#4a9eff
    style Route fill:#4a9eff
    style Bus fill:#4a9eff
    style Trip fill:#4a9eff
    style Booking fill:#4a9eff
    style Ticket fill:#4a9eff
    style Payment fill:#4a9eff
    style Staff fill:#90EE90
    style Voucher fill:#90EE90
    style Review fill:#FFD700
    style Notification fill:#FFD700
    style Content fill:#FFD700
    style SupportTicket fill:#FFD700
```

**Ghi ch√∫ Class Diagram:**
- üîµ **M√†u xanh d∆∞∆°ng:** Models ƒë√£ implement t·ª´ tr∆∞·ªõc (User, BusOperator, Route, Bus, Trip, Booking, Ticket, Payment)
- üü¢ **M√†u xanh l√°:** Models critical m·ªõi implement (Staff, Voucher)
- üü° **M√†u v√†ng:** Models nice-to-have m·ªõi implement (Review, Notification, Content, SupportTicket)
- `*` = Required field
- Embedded documents (nh∆∞ `passenger`, `seatLayout`, `lockedSeats`) kh√¥ng ƒë∆∞·ª£c hi·ªÉn th·ªã ri√™ng v√¨ ƒë∆∞·ª£c nh√∫ng trong parent model

---

### 2.5 Quan H·ªá Gi·ªØa C√°c L·ªõp (D·ª±a Tr√™n Code Th·ª±c T·∫ø)

#### **2.5.1 Quan h·ªá Reference (ObjectId References)**

Trong MongoDB, c√°c models ƒë∆∞·ª£c li√™n k·∫øt th√¥ng qua ObjectId references:

**User Model:**
- `User` ‚Üê `Booking.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu bookings
- `User` ‚Üê `Payment.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu payments
- `User` ‚Üê `Ticket.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu tickets
- `User` ‚Üê `Review.customerId` (1:N) - M·ªôt user c√≥ nhi·ªÅu reviews
- `User` ‚Üê `Notification.userId` (1:N) - M·ªôt user c√≥ nhi·ªÅu notifications
- `User` ‚Üê `Content.createdBy` (1:N) - M·ªôt user t·∫°o nhi·ªÅu contents
- `User` ‚Üê `SupportTicket.userId` (1:N) - M·ªôt user c√≥ nhi·ªÅu tickets

**BusOperator Model:**
- `BusOperator` ‚Üê `Route.operatorId` (1:N) - M·ªôt nh√† xe qu·∫£n l√Ω nhi·ªÅu tuy·∫øn
- `BusOperator` ‚Üê `Bus.operatorId` (1:N) - M·ªôt nh√† xe s·ªü h·ªØu nhi·ªÅu xe
- `BusOperator` ‚Üê `Trip.operatorId` (1:N) - M·ªôt nh√† xe v·∫≠n h√†nh nhi·ªÅu chuy·∫øn
- `BusOperator` ‚Üê `Booking.operatorId` (1:N) - M·ªôt nh√† xe nh·∫≠n nhi·ªÅu bookings
- `BusOperator` ‚Üê `Staff.operatorId` (1:N) - M·ªôt nh√† xe c√≥ nhi·ªÅu nh√¢n vi√™n
- `BusOperator` ‚Üê `Voucher.operatorId` (1:N) - M·ªôt nh√† xe t·∫°o nhi·ªÅu vouchers
- `BusOperator` ‚Üê `Review.operatorId` (1:N) - M·ªôt nh√† xe nh·∫≠n nhi·ªÅu reviews

**Route Model:**
- `Route` ‚Üê `Trip.routeId` (1:N) - M·ªôt tuy·∫øn c√≥ nhi·ªÅu chuy·∫øn
- `Route` ‚Üê `Voucher.applicableRoutes` (N:M) - Voucher √°p d·ª•ng cho nhi·ªÅu tuy·∫øn

**Bus Model:**
- `Bus` ‚Üê `Trip.busId` (1:N) - M·ªôt xe th·ª±c hi·ªán nhi·ªÅu chuy·∫øn

**Trip Model:**
- `Trip` ‚Üê `Booking.tripId` (1:N) - M·ªôt chuy·∫øn c√≥ nhi·ªÅu bookings
- `Trip` ‚Üê `Ticket.tripId` (1:N) - M·ªôt chuy·∫øn c√≥ nhi·ªÅu tickets
- `Trip` ‚Üí `Staff (driver)` (N:1) - Nhi·ªÅu chuy·∫øn c√≥ th·ªÉ c√≥ c√πng t√†i x·∫ø
- `Trip` ‚Üí `Staff (tripManager)` (N:1) - Nhi·ªÅu chuy·∫øn c√≥ th·ªÉ c√≥ c√πng qu·∫£n l√Ω
- `Trip` ‚Üê `Review.tripId` (1:N) - M·ªôt chuy·∫øn c√≥ nhi·ªÅu reviews

**Booking Model:**
- `Booking` ‚Üê `Ticket.bookingId` (1:N) - M·ªôt booking t·∫°o nhi·ªÅu tickets
- `Booking` ‚Üê `Payment.bookingId` (1:1) - M·ªôt booking c√≥ m·ªôt payment
- `Booking` ‚Üí `Voucher.voucherId` (N:1) - Nhi·ªÅu bookings c√≥ th·ªÉ d√πng c√πng voucher
- `Booking` ‚Üí `Staff.checkedInBy` (N:1) - Nhi·ªÅu bookings ƒë∆∞·ª£c check-in b·ªüi c√πng staff
- `Booking` ‚Üê `Review.bookingId` (1:1) - M·ªôt booking c√≥ m·ªôt review
- `Booking` ‚Üê `SupportTicket.relatedBookingId` (1:N) - M·ªôt booking c√≥ th·ªÉ c√≥ nhi·ªÅu tickets

**Ticket Model:**
- `Ticket` ‚Üí `Staff.validatedBy` (N:1) - Nhi·ªÅu tickets ƒë∆∞·ª£c validate b·ªüi c√πng staff

**Staff Model:**
- `Staff` ‚Üê `Trip.driver` (1:N) - M·ªôt staff c√≥ th·ªÉ l√°i nhi·ªÅu chuy·∫øn
- `Staff` ‚Üê `Trip.tripManager` (1:N) - M·ªôt staff c√≥ th·ªÉ qu·∫£n l√Ω nhi·ªÅu chuy·∫øn
- `Staff` ‚Üê `Booking.checkedInBy` (1:N) - M·ªôt staff check-in nhi·ªÅu bookings
- `Staff` ‚Üê `Ticket.validatedBy` (1:N) - M·ªôt staff validate nhi·ªÅu tickets

#### **2.5.2 Quan h·ªá Embedded (Nested Documents)**

C√°c documents ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp trong parent document (kh√¥ng ph·∫£i reference):

**User Model:**
- `savedPassengers`: Array of embedded { fullName, phone, idCard }

**BusOperator Model:**
- `address`: Embedded { street, ward, district, city, country }
- `bankAccount`: Embedded { bankName, accountNumber, accountHolder }

**Route Model:**
- `origin`: Embedded { city, province, station, address, coordinates }
- `destination`: Embedded { city, province, station, address, coordinates }
- `pickupPoints`: Array of embedded { name, address, coordinates }
- `dropoffPoints`: Array of embedded { name, address, coordinates }

**Bus Model:**
- `seatLayout`: Embedded { floors, rows, columns, layout }

**Trip Model:**
- `occupiedSeats`: Array of String
- `lockedSeats`: Array of embedded { seatNumber, lockedUntil, sessionId }

**Booking Model:**
- `seats`: Array of embedded { seatNumber, passenger: { fullName, phone, idCard } }
- `pickupPoint`: Embedded { name, address, coordinates }
- `dropoffPoint`: Embedded { name, address, coordinates }

**Ticket Model:**
- `passenger`: Embedded { fullName, phone, idCard }
- `tripDetails`: Embedded { routeName, origin, destination, departureTime, busNumber, operatorName }

**Payment Model:**
- `gatewayResponse`: Mixed (object ch·ª©a raw response t·ª´ payment gateway)

**SupportTicket Model:**
- `messages`: Array of embedded { sender, senderType, message, attachments, createdAt }

#### **2.5.3 ƒê·∫∑c ƒêi·ªÉm Thi·∫øt K·∫ø MongoDB**

**1. Denormalization (Phi chu·∫©n h√≥a):**
- `Ticket.tripDetails` ch·ª©a th√¥ng tin denormalized t·ª´ Trip, Route, Bus - Tr√°nh join khi hi·ªÉn th·ªã v√©
- `Booking.operatorId` duplicate t·ª´ Trip - Optimize query bookings by operator

**2. Embedded vs Referenced:**
- **Embedded:** D·ªØ li·ªáu kh√¥ng c·∫ßn query ri√™ng (passenger, seatLayout, lockedSeats, messages)
- **Referenced:** D·ªØ li·ªáu c·∫ßn query ƒë·ªôc l·∫≠p ho·∫∑c ƒë∆∞·ª£c share (User, Trip, Bus, Route, Staff, Voucher)

**3. Array Fields:**
- `occupiedSeats`, `lockedSeats`, `seats`, `pickupPoints`, `messages`, `applicableRoutes` - Cho ph√©p query linh ho·∫°t
- Indexes ƒë∆∞·ª£c t·∫°o tr√™n c√°c array fields quan tr·ªçng

---

### 2.6 T√≥m T·∫Øt Index Strategy

| Model | Indexes | L√Ω Do |
|-------|---------|-------|
| **User** | email, phone, googleId, facebookId | ƒêƒÉng nh·∫≠p v√† authentication |
| **BusOperator** | companyName, email, verificationStatus | T√¨m ki·∫øm v√† qu·∫£n l√Ω nh√† xe |
| **Route** | routeCode, operatorId, origin.city+destination.city | T√¨m ki·∫øm tuy·∫øn ƒë∆∞·ªùng |
| **Bus** | operatorId, busNumber | Qu·∫£n l√Ω xe theo nh√† xe |
| **Trip** | tripCode, operatorId+departureTime, routeId+departureTime, departureTime+status | T√¨m ki·∫øm v√† l·ªçc chuy·∫øn xe |
| **Booking** | bookingCode, customerId, tripId, status, createdAt | Qu·∫£n l√Ω v√† tra c·ª©u booking |
| **Ticket** | ticketCode, bookingId, qrData, customerId | Validate v√† tra c·ª©u v√© |
| **Payment** | transactionId, bookingId, customerId, status, createdAt | Theo d√µi giao d·ªãch |
| **Staff** | employeeCode, operatorId+status, role, email | T√¨m ki·∫øm nh√¢n vi√™n theo operator, role v√† status |
| **Voucher** | code, operatorId+isActive, validFrom+validTo | Validate voucher v√† t√¨m voucher kh·∫£ d·ª•ng |
| **Review** | bookingId, customerId, operatorId+isApproved, tripId, createdAt | Hi·ªÉn th·ªã reviews theo nh√† xe, trip, v√† s·∫Øp x·∫øp |
| **Notification** | userId+status, userId+readAt, type+status, scheduledFor+status | Query notifications ch∆∞a ƒë·ªçc v√† scheduled |
| **Content** | slug, type+isActive, type+order, featured+isActive | SEO-friendly URLs v√† hi·ªÉn th·ªã content |
| **SupportTicket** | ticketNumber, userId+status, assignedTo+status, category+status | Qu·∫£n l√Ω v√† ph√¢n c√¥ng tickets |

---

**Ghi ch√∫ chung:**
- T·∫•t c·∫£ models ƒë·ªÅu c√≥ timestamps (createdAt, updatedAt)
- C√°c ph∆∞∆°ng th·ª©c static ph·ª•c v·ª• business logic ph·ª©c t·∫°p
- C√°c ph∆∞∆°ng th·ª©c instance ph·ª•c v·ª• operations tr√™n document c·ª• th·ªÉ
- Hooks (pre/post-save) ƒë·∫£m b·∫£o data integrity v√† side effects
- Composite indexes ƒë∆∞·ª£c t·∫°o cho c√°c query patterns ph·ªï bi·∫øn

---

## K·∫æT LU·∫¨N

T√†i li·ªáu n√†y ƒë√£ m√¥ t·∫£ chi ti·∫øt **14 MongoDB Models** cho h·ªá th·ªëng ƒë·∫∑t v√© xe kh√°ch tr·ª±c tuy·∫øn, bao g·ªìm:

‚úÖ **8 Models ƒë√£ implement t·ª´ tr∆∞·ªõc:**
- User, BusOperator, Route, Bus, Trip, Booking, Ticket, Payment

‚úÖ **6 Models m·ªõi implement ƒë·∫ßy ƒë·ªß:**
- **Critical:** Staff, Voucher
- **Nice to Have:** Review, Notification, Content, SupportTicket

M·ªói model ƒë·ªÅu ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi:
- **Thu·ªôc t√≠nh:** ƒê·∫ßy ƒë·ªß c√°c fields c·∫ßn thi·∫øt v·ªõi validation
- **Indexes:** T·ªëi ∆∞u h√≥a performance cho c√°c query patterns
- **Ph∆∞∆°ng th·ª©c:** Business logic v√† helper functions
- **Relationships:** References v√† embedded documents ph√π h·ª£p v·ªõi MongoDB best practices

Thi·∫øt k·∫ø n√†y c√¢n b·∫±ng gi·ªØa:
- **Normalization vs Denormalization:** ƒê·ªÉ t·ªëi ∆∞u performance
- **Embedded vs Referenced:** D·ª±a tr√™n access patterns
- **Scalability:** Indexes v√† data modeling cho future growth
